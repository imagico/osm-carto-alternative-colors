# This is generated code, do not change this file manually.
# 
# To change these definitions, alter symbols-labels.yaml and run:
# 
#   ./scripts/generate_symbols_labels.py
# 
# Content subject to AGPL v3.0/CC BY-SA 4.0 - see LICENSE.txt for details
# 
  - id: amenity-points
    geometry: point
    <<: *extents
    Datasource:
      geometry_table: planet_osm_point
      <<: *osm2pgsql
      table: |-
        (SELECT
            *
          FROM
          ( -- this subselect (with CTE) allows splitting and where necessary duplicating features for separate rendering of symbol and label
            WITH zoom_thresholds AS
            (SELECT -- this subselect generates the zoom level threshols and allows filtering for them
                way,
                "name",
                "lang",
                "font",
                "ref",
                "operator",
                "brand",
                "osm_id",
                combined.feature AS feature,
                combined.variant AS variant,
                CASE
                  WHEN combined.feature = 'tourism_information' THEN
                    CASE
                      WHEN combined.variant = 'information_audioguide' THEN 19
                      WHEN combined.variant = 'information_board' THEN 19
                      WHEN combined.variant = 'information_sign' THEN 19
                      WHEN combined.variant = 'information_guidepost' THEN 19
                      WHEN combined.variant = 'information_map' THEN 19
                      WHEN combined.variant = 'information_terminal' THEN 19
                      ELSE 17
                    END
                  WHEN combined.feature = 'amenity_toilets' THEN
                    CASE
                      WHEN combined.variant = 'access_yes' THEN 17
                      ELSE 18
                    END
                  WHEN combined.feature = 'amenity_parking' THEN
                    CASE
                      WHEN combined.variant = 'street_side' THEN GREATEST(18, zoom_threshold)
                      ELSE GREATEST(14, zoom_threshold)
                    END
                  WHEN combined.feature = 'amenity_recycling' THEN
                    CASE
                      WHEN combined.variant = 'centre' THEN 17
                      WHEN combined.variant = 'container' THEN 18
                      ELSE 19
                    END
                  WHEN combined.feature = 'aeroway_aerodrome' THEN
                    CASE
                      WHEN combined.variant = 'public' THEN 10
                      ELSE 11
                    END
                  WHEN combined.feature = 'power_generator/wind' THEN
                    CASE
                      WHEN combined.variant = 'offshore' THEN 13
                      ELSE 15
                    END
                  WHEN combined.feature = 'man_made_mast' THEN
                    CASE
                      WHEN combined.variant = 'height_160' THEN 14
                      WHEN combined.variant = 'height_80' THEN 15
                      WHEN combined.variant = 'height_40' THEN 16
                      WHEN combined.variant = 'height_20' THEN 17
                      ELSE 18
                    END
                  WHEN combined.feature = 'man_made_tower' THEN
                    CASE
                      WHEN combined.variant = 'height_160' THEN 14
                      WHEN combined.variant = 'height_80' THEN 15
                      WHEN combined.variant = 'height_40' THEN 16
                      WHEN combined.variant = 'minor_types' THEN 18
                      ELSE 17
                    END
                  WHEN combined.feature = 'historic_memorial' THEN
                    CASE
                      WHEN combined.variant = 'medium' THEN 18
                      WHEN combined.variant = 'small' THEN 19
                      ELSE 17
                    END
                  WHEN combined.feature = 'historic_castle' THEN
                    CASE
                      WHEN combined.variant = 'minor_types' THEN 16
                      ELSE 15
                    END
                  WHEN combined.feature = 'shop' THEN
                    CASE
                      WHEN combined.variant = 'early' THEN 16
                      ELSE 17
                    END
                  WHEN combined.feature = 'office' THEN
                    CASE
                      WHEN combined.variant = 'diplomatic' THEN 17
                      ELSE 18
                    END
                  WHEN combined.feature IN ('aeroway_helipad', 'amenity_bus_station', 'amenity_cinema', 'amenity_clinic', 'amenity_courthouse', 'amenity_fire_station', 'amenity_hunting_stand', 'amenity_library', 'amenity_place_of_worship', 'amenity_police', 'amenity_shelter', 'amenity_theatre', 'amenity_townhall', 'barrier_toll_booth', 'highway_bus_stop', 'historic_archaeological_site', 'historic_fort', 'historic_manor', 'historic_monument', 'historic_wayside_cross', 'historic_wayside_shrine', 'leisure_beach_resort', 'man_made_cross', 'man_made_windmill', 'man_made_windpump', 'tourism_museum', 'tourism_picnic_site', 'tourism_viewpoint') THEN 16
                  WHEN combined.feature IN ('aerialway_station', 'natural_volcano', 'railway_halt', 'railway_tram_stop', 'tourism_alpine_hut', 'tourism_wilderness_hut') THEN 13
                  WHEN combined.feature IN ('aeroway_gate', 'amenity_arts_centre', 'amenity_atm', 'amenity_bank', 'amenity_bar', 'amenity_bbq', 'amenity_bicycle_rental', 'amenity_biergarten', 'amenity_cafe', 'amenity_car_rental', 'amenity_car_wash', 'amenity_charging_station', 'amenity_community_centre', 'amenity_dentist', 'amenity_doctors', 'amenity_drinking_water', 'amenity_driving_school', 'amenity_fast_food', 'amenity_food_court', 'amenity_fountain', 'amenity_fuel', 'amenity_ice_cream', 'amenity_nightclub', 'amenity_pharmacy', 'amenity_phone', 'amenity_post_box', 'amenity_post_office', 'amenity_prison', 'amenity_pub', 'amenity_public_bath', 'amenity_restaurant', 'amenity_social_facility', 'amenity_taxi', 'amenity_veterinary', 'amenity_water_point', 'barrier_block', 'barrier_bollard', 'barrier_cattle_grid', 'barrier_full-height_turnstile', 'barrier_gate', 'barrier_hampshire_gate', 'barrier_kissing_gate', 'barrier_lift_gate', 'barrier_log', 'barrier_sliding_gate', 'barrier_stile', 'barrier_swing_gate', 'barrier_turnstile', 'highway_traffic_signals', 'historic_city_gate', 'leisure_firepit', 'leisure_miniature_golf', 'leisure_picnic_table', 'leisure_playground', 'leisure_sauna', 'leisure_slipway', 'man_made_crane', 'man_made_obelisk', 'man_made_petroleum_well', 'man_made_reservoir_covered', 'man_made_telescope', 'man_made_water_tap', 'man_made_water_tower', 'man_made_watermill', 'military_bunker', 'shop_massage', 'tourism_artwork', 'tourism_camp_site', 'tourism_caravan_site', 'tourism_charlet', 'tourism_guest_house', 'tourism_hostel', 'tourism_hotel', 'tourism_motel') THEN 17
                  WHEN combined.feature IN ('amenity_bench', 'amenity_lounger', 'amenity_parking_entrance/multi-storey', 'amenity_parking_entrance/underground', 'amenity_shower', 'amenity_waste_disposal', 'barrier_chain', 'barrier_cycle_barrier', 'barrier_height_restrictor', 'highway_elevator', 'man_made_planter', 'railway_subway_entrance', 'tourism_apartment') THEN 18
                  WHEN combined.feature IN ('amenity_bicycle_parking', 'amenity_motorcycle_parking', 'leisure_water_park') THEN GREATEST(14, zoom_threshold)
                  WHEN combined.feature IN ('amenity_ferry_terminal', 'amenity_hospital', 'leisure_golf_course', 'man_made_lighthouse', 'man_made_water_well', 'natural_cave_entrance', 'natural_saddle', 'railway_crossing') THEN 15
                  WHEN combined.feature IN ('advertising_column', 'amenity_waste_basket', 'barrier_wicket_gate', 'emergency_life_ring', 'emergency_phone') THEN 19
                  WHEN combined.feature IN ('man_made_communications_tower', 'natural_geyser', 'natural_hot_spring', 'natural_spring', 'railway_level_crossing') THEN 14
                  WHEN combined.feature IN ('railway_station') THEN 12
                  WHEN combined.feature IN ('natural_peak', 'natural_peak/viewpoint') THEN 11
                  WHEN combined.feature IN ('amenity_marketplace', 'man_made_bunker_silo', 'man_made_silo', 'man_made_storage_tank') THEN GREATEST(16, zoom_threshold)
                  WHEN combined.feature IN ('man_made_gasometer', 'man_made_heap', 'man_made_spoil_heap') THEN GREATEST(15, zoom_threshold)
                END AS start_symbol,
                CASE
                  WHEN combined.feature = 'tourism_information' THEN
                    CASE
                      WHEN combined.variant = 'information_audioguide' THEN 19
                      WHEN combined.variant = 'information_board' THEN 19
                      WHEN combined.variant = 'information_sign' THEN 19
                      WHEN combined.variant = 'information_guidepost' THEN 19
                      WHEN combined.variant = 'information_map' THEN 19
                      WHEN combined.variant = 'information_terminal' THEN 19
                      ELSE 17
                    END
                  WHEN combined.feature = 'amenity_recycling' THEN
                    CASE
                      WHEN combined.variant = 'centre' THEN 17
                      ELSE 19
                    END
                  WHEN combined.feature = 'aeroway_aerodrome' THEN
                    CASE
                      WHEN combined.variant = 'public' THEN 10
                      ELSE 11
                    END
                  WHEN combined.feature = 'power_generator/wind' THEN
                    CASE
                      WHEN combined.variant = 'offshore' THEN 15
                      ELSE 17
                    END
                  WHEN combined.feature = 'man_made_tower' THEN
                    CASE
                      WHEN combined.variant = 'height_160' THEN 17
                      WHEN combined.variant = 'height_80' THEN 17
                      WHEN combined.variant = 'height_40' THEN 17
                      WHEN combined.variant = 'minor_types' THEN 19
                      ELSE 18
                    END
                  WHEN combined.feature = 'historic_memorial' THEN
                    CASE
                      WHEN combined.variant = 'medium' THEN 18
                      WHEN combined.variant = 'small' THEN 19
                      ELSE 17
                    END
                  WHEN combined.feature = 'office' THEN
                    CASE
                      WHEN combined.variant = 'diplomatic' THEN 17
                      WHEN combined.variant = 'large' THEN 18
                      ELSE 19
                    END
                  WHEN combined.feature IN ('amenity_arts_centre', 'amenity_atm', 'amenity_bank', 'amenity_bar', 'amenity_bbq', 'amenity_bicycle_rental', 'amenity_biergarten', 'amenity_bus_station', 'amenity_cafe', 'amenity_car_rental', 'amenity_car_wash', 'amenity_charging_station', 'amenity_cinema', 'amenity_clinic', 'amenity_community_centre', 'amenity_courthouse', 'amenity_dentist', 'amenity_doctors', 'amenity_drinking_water', 'amenity_fast_food', 'amenity_fire_station', 'amenity_food_court', 'amenity_fountain', 'amenity_fuel', 'amenity_hunting_stand', 'amenity_ice_cream', 'amenity_library', 'amenity_nightclub', 'amenity_pharmacy', 'amenity_place_of_worship', 'amenity_police', 'amenity_post_office', 'amenity_prison', 'amenity_pub', 'amenity_public_bath', 'amenity_restaurant', 'amenity_shelter', 'amenity_social_facility', 'amenity_taxi', 'amenity_theatre', 'amenity_townhall', 'amenity_veterinary', 'amenity_water_point', 'barrier_toll_booth', 'highway_bus_stop', 'historic_archaeological_site', 'historic_city_gate', 'historic_wayside_cross', 'historic_wayside_shrine', 'leisure_beach_resort', 'leisure_firepit', 'leisure_miniature_golf', 'leisure_picnic_table', 'leisure_playground', 'leisure_sauna', 'leisure_slipway', 'man_made_communications_tower', 'man_made_crane', 'man_made_cross', 'man_made_obelisk', 'man_made_petroleum_well', 'man_made_reservoir_covered', 'man_made_telescope', 'man_made_water_tap', 'man_made_water_tower', 'man_made_windmill', 'man_made_windpump', 'military_bunker', 'natural_tree', 'shop_massage', 'tourism_artwork', 'tourism_camp_site', 'tourism_caravan_site', 'tourism_charlet', 'tourism_guest_house', 'tourism_hostel', 'tourism_hotel', 'tourism_motel', 'tourism_museum', 'tourism_picnic_site') THEN 17
                  WHEN combined.feature IN ('aerialway_station', 'natural_bay', 'railway_station', 'tourism_alpine_hut', 'tourism_wilderness_hut') THEN 14
                  WHEN combined.feature IN ('amenity_driving_school', 'amenity_shower', 'man_made_mast', 'man_made_watermill', 'shop', 'tourism_apartment') THEN 18
                  WHEN combined.feature IN ('aeroway_helipad', 'amenity_ferry_terminal', 'amenity_hospital', 'historic_castle', 'historic_fort', 'historic_manor', 'historic_monument', 'man_made_water_well', 'natural_geyser', 'natural_hot_spring', 'natural_spring', 'railway_tram_stop', 'tourism_viewpoint') THEN 16
                  WHEN combined.feature IN ('barrier_height_restrictor') THEN 20
                  WHEN combined.feature IN ('railway_subway_entrance') THEN 19
                  WHEN combined.feature IN ('leisure_golf_course', 'man_made_lighthouse', 'natural_cave_entrance', 'natural_saddle', 'natural_volcano', 'railway_halt') THEN 15
                  WHEN combined.feature IN ('natural_peak', 'natural_peak/viewpoint') THEN 13
                  WHEN combined.feature IN ('man_made_bunker_silo', 'man_made_silo', 'man_made_storage_tank') THEN GREATEST(18, zoom_threshold)
                  WHEN combined.feature IN ('amenity_marketplace', 'man_made_gasometer', 'man_made_heap', 'man_made_spoil_heap') THEN GREATEST(17, zoom_threshold)
                  WHEN combined.feature IN ('man_made_bridge') THEN GREATEST(12, zoom_threshold)
                  WHEN combined.feature IN ('leisure_swimming_pool', 'leisure_water_park') THEN GREATEST(14, zoom_threshold)
                  WHEN combined.feature IN ('aeroway_apron', 'amenity_college', 'amenity_grave_yard', 'amenity_kindergarten', 'amenity_school', 'amenity_university', 'landuse_allotments', 'landuse_basin', 'landuse_brownfield', 'landuse_cemetery', 'landuse_commercial', 'landuse_construction', 'landuse_farmland', 'landuse_farmyard', 'landuse_forest', 'landuse_grass', 'landuse_greenhouse_horticulture', 'landuse_landfill', 'landuse_meadow', 'landuse_military', 'landuse_quarry', 'landuse_recreation_ground', 'landuse_reservoir', 'landuse_village_green', 'leisure_common', 'leisure_dog_park', 'leisure_fitness_centre', 'leisure_fitness_station', 'leisure_garden', 'leisure_park', 'leisure_sport_centre', 'leisure_stadium', 'military_danger_area', 'natural_bare_rock', 'natural_beach', 'natural_glacier', 'natural_grassland', 'natural_heath', 'natural_mud', 'natural_reef', 'natural_sand', 'natural_scree', 'natural_scrub', 'natural_shingle', 'natural_shoal', 'natural_water', 'natural_wetland', 'natural_wood', 'place_archipelago', 'place_island', 'power_generator', 'power_plant', 'shop_mall', 'tourism_theme_park', 'tourism_zoo') THEN GREATEST(10, zoom_threshold)
                  WHEN combined.feature IN ('place_islet') THEN GREATEST(11, zoom_threshold)
                  WHEN combined.feature IN ('highway_rest_area', 'highway_services', 'landuse_garages', 'landuse_industrial', 'landuse_railway', 'landuse_residential', 'landuse_retail', 'man_made_works', 'power_substation') THEN GREATEST(13, zoom_threshold)
                  WHEN combined.feature IN ('leisure_marina') THEN GREATEST(15, zoom_threshold)
                END AS start_label,
                f.prio AS prio,
                "height" AS score,
                "int_elevation",
                "shelter_type",
                "information",
                "int_access",
                "parking",
                "int_bench_type",
                "backrest",
                "waste",
                "recycling_type",
                "int_gate_type",
                "int_barrier_orientation",
                "stile",
                "kissing_gate",
                "int_maxheight",
                "int_text_dy_viewpoint",
                "int_offset_x_viewpoint",
                "int_offset_y_viewpoint",
                "int_width_viewpoint",
                "int_height_viewpoint",
                "icao",
                "iata",
                "drinking_water",
                "intermittent",
                "int_text_offset_tree",
                "location",
                "offshore",
                "content",
                "resource",
                "int_lighthouse_type",
                "telescope:type",
                "crane:type",
                "height",
                "tower:type",
                "int_tower_type",
                "int_petroleum_well_type",
                "memorial",
                "castle_type",
                "religion",
                "shop",
                "office",
                "diplomatic",
                "building",
                way_area,
                way_length,
                way_pixels
              FROM
              (SELECT -- this subselect generates the variant and zoom_threshold columns and expands arrays
                  CASE
                    WHEN feature IN ('amenity_bicycle_parking', 'amenity_motorcycle_parking', 'amenity_parking', 'natural_peak', 'natural_peak/viewpoint') THEN
                      ST_SnapToGrid(
                        way,
                        NULLIF(!scale_denominator!*0.001*0.28,0), NULLIF(!scale_denominator!*0.001*0.28,0))
                    ELSE way
                  END AS way,
                  "_name_label"[1] AS "name",
                  "_name_label"[2] AS "lang",
                  "_name_label"[3] AS "font",
                  "ref",
                  "operator",
                  "brand",
                  "osm_id",
                  feature,
                  CASE
                    WHEN feature = 'tourism_information' THEN
                      CASE
                        WHEN information IN ('audioguide') THEN 'information_audioguide'
                        WHEN information IN ('board') THEN 'information_board'
                        WHEN information IN ('sign') THEN 'information_sign'
                        WHEN information IN ('guidepost') THEN 'information_guidepost'
                        WHEN information IN ('map', 'tactile_map') THEN 'information_map'
                        WHEN information IN ('terminal') THEN 'information_terminal'
                        WHEN information IN ('visitor_centre') THEN 'information_visitor_centre'
                      END
                    WHEN feature = 'amenity_toilets' THEN
                      CASE
                        WHEN int_access = 'yes' THEN 'access_yes'
                      END
                    WHEN feature = 'amenity_parking' THEN
                      CASE
                        WHEN "parking" IN ('street_side', 'lane') THEN 'street_side'
                      END
                    WHEN feature = 'amenity_waste_basket' THEN
                      CASE
                        WHEN waste IN ('recycling') THEN 'recycling'
                      END
                    WHEN feature = 'amenity_recycling' THEN
                      CASE
                        WHEN recycling_type IN ('centre') THEN 'centre'
                        WHEN recycling_type IN ('container') THEN 'container'
                      END
                    WHEN feature = 'aeroway_aerodrome' THEN
                      CASE
                        WHEN int_access = 'yes' AND icao IS NOT NULL AND iata IS NOT NULL THEN 'public'
                      END
                    WHEN feature = 'amenity_water_point' THEN
                      CASE
                        WHEN drinking_water = 'yes' THEN 'drinking_water'
                      END
                    WHEN feature = 'natural_spring' THEN
                      CASE
                        WHEN EXISTS (SELECT 1 FROM planet_osm_line l WHERE ST_DWithin(features.way, l.way, 0.1) AND l.waterway IN ('river', 'canal', 'stream', 'ditch', 'drain')) THEN 'connected'
                      END
                    WHEN feature = 'natural_hot_spring' THEN
                      CASE
                        WHEN EXISTS (SELECT 1 FROM planet_osm_line l WHERE ST_DWithin(features.way, l.way, 0.1) AND l.waterway IN ('river', 'canal', 'stream', 'ditch', 'drain')) THEN 'connected'
                      END
                    WHEN feature = 'power_generator/wind' THEN
                      CASE
                        WHEN "offshore" = 'yes' THEN 'offshore'
                      END
                    WHEN feature = 'man_made_mast' THEN
                      CASE
                        WHEN (height >= 160) AND "tower:type" NOT IN ('lighting') THEN 'height_160'
                        WHEN (height >= 80) AND "tower:type" NOT IN ('lighting') THEN 'height_80'
                        WHEN (height >= 40) AND "tower:type" NOT IN ('lighting') THEN 'height_40'
                        WHEN (height >= 20) AND "tower:type" NOT IN ('lighting') THEN 'height_20'
                      END
                    WHEN feature = 'man_made_tower' THEN
                      CASE
                        WHEN (height >= 160) AND "tower:type" NOT IN ('lighting', 'bell_tower') THEN 'height_160'
                        WHEN (height >= 80) AND "tower:type" NOT IN ('lighting', 'bell_tower') THEN 'height_80'
                        WHEN (height >= 40) AND "tower:type" NOT IN ('lighting', 'bell_tower') THEN 'height_40'
                        WHEN "tower:type" IN ('lighting', 'bell_tower') THEN 'minor_types'
                      END
                    WHEN feature = 'historic_memorial' THEN
                      CASE
                        WHEN memorial IN ('bust', 'stele', 'stone') THEN 'medium'
                        WHEN memorial IN ('plaque', 'blue_plaque') THEN 'small'
                      END
                    WHEN feature = 'historic_castle' THEN
                      CASE
                        WHEN castle_type IN ('stately', 'manor') THEN 'minor_types'
                      END
                    WHEN feature = 'shop' THEN
                      CASE
                        WHEN shop IN ('supermarket', 'department_store') THEN 'early'
                      END
                    WHEN feature = 'office' THEN
                      CASE
                        WHEN diplomatic IN ('embassy', 'consulate') THEN 'diplomatic'
                        WHEN office IN ('accountant', 'adoption_agency', 'advertising_agency', 'architect', 'association', 'charity', 'company', 'educational_institution', 'employment_agency',  'energy_supplier', 'estate_agent', 'financial', 'forestry', 'foundation', 'government', 'guide', 'insurance', 'it', 'lawyer', 'logistics', 'moving_company', 'newspaper', 'ngo', 'notary', 'political_party', 'private_investigator', 'property_management', 'quango', 'religion', 'research', 'surveyor', 'tax', 'tax_advisor', 'telecommunication', 'travel_agent', 'water_utility') THEN 'large'
                      END
                  END AS variant,
                  CASE
                    WHEN feature IN ('amenity_bicycle_parking', 'amenity_motorcycle_parking', 'amenity_parking') THEN LEAST(zoom_from_pixelsize(SQRT(way_area/900)::numeric), 16)
                    WHEN feature IN ('man_made_bunker_silo', 'man_made_silo', 'man_made_storage_tank') THEN LEAST(zoom_from_pixelsize(SQRT(way_area/300)::numeric), 18)
                    WHEN feature IN ('man_made_gasometer', 'man_made_heap', 'man_made_spoil_heap') THEN LEAST(zoom_from_pixelsize(SQRT(way_area/300)::numeric), 17)
                    WHEN feature IN ('man_made_bridge') THEN zoom_from_pixelsize(SQRT(way_area/62.5)::numeric)
                    WHEN feature IN ('aeroway_apron', 'amenity_college', 'amenity_grave_yard', 'amenity_kindergarten', 'amenity_marketplace', 'amenity_school', 'amenity_university', 'highway_rest_area', 'highway_services', 'landuse_allotments', 'landuse_basin', 'landuse_brownfield', 'landuse_cemetery', 'landuse_commercial', 'landuse_construction', 'landuse_farmland', 'landuse_farmyard', 'landuse_forest', 'landuse_garages', 'landuse_grass', 'landuse_greenhouse_horticulture', 'landuse_industrial', 'landuse_landfill', 'landuse_meadow', 'landuse_military', 'landuse_quarry', 'landuse_railway', 'landuse_recreation_ground', 'landuse_reservoir', 'landuse_residential', 'landuse_retail', 'landuse_village_green', 'leisure_common', 'leisure_dog_park', 'leisure_fitness_centre', 'leisure_fitness_station', 'leisure_garden', 'leisure_marina', 'leisure_park', 'leisure_sport_centre', 'leisure_stadium', 'leisure_swimming_pool', 'leisure_water_park', 'man_made_works', 'military_danger_area', 'natural_bare_rock', 'natural_beach', 'natural_grassland', 'natural_heath', 'natural_mud', 'natural_reef', 'natural_sand', 'natural_scree', 'natural_scrub', 'natural_shingle', 'natural_shoal', 'natural_water', 'natural_wetland', 'natural_wood', 'place_islet', 'power_generator', 'power_plant', 'power_substation', 'shop_mall', 'tourism_theme_park', 'tourism_zoo') THEN LEAST(zoom_from_pixelsize(SQRT(way_area/3000)::numeric), 17)
                    WHEN feature IN ('place_archipelago', 'place_island') THEN LEAST(zoom_from_pixelsize(SQRT(way_area/3000)::numeric), 16)
                    WHEN feature IN ('natural_glacier') THEN LEAST(zoom_from_pixelsize(SQRT(way_area/750)::numeric), 17)
                  END AS zoom_threshold,
                  "int_elevation",
                  "shelter_type",
                  "information",
                  "int_access",
                  "parking",
                  "int_bench_type",
                  "backrest",
                  "waste",
                  "recycling_type",
                  "int_gate_type",
                  "int_barrier_orientation",
                  "stile",
                  "kissing_gate",
                  "int_maxheight",
                  CASE WHEN int_symbol_geometry IS NOT NULL THEN GREATEST(CASE WHEN feature = 'natural_peak/viewpoint' THEN 7 ELSE 0 END, ROUND((ST_Y(way)-ST_YMin(int_symbol_geometry)) / NULLIF(!scale_denominator!*0.001*0.28,0) + 3.0)) END AS "int_text_dy_viewpoint",
                  CASE WHEN int_symbol_geometry IS NOT NULL THEN ROUND((0.5*(ST_XMin(int_symbol_geometry)+ST_XMax(int_symbol_geometry)) - ST_X(way)) / NULLIF(!scale_denominator!*0.001*0.28,0)) END AS "int_offset_x_viewpoint",
                  CASE WHEN int_symbol_geometry IS NOT NULL THEN ROUND((ST_Y(way) - (0.5*(ST_YMin(int_symbol_geometry)+ST_YMax(int_symbol_geometry)))) / NULLIF(!scale_denominator!*0.001*0.28,0)) END AS "int_offset_y_viewpoint",
                  CASE WHEN int_symbol_geometry IS NOT NULL THEN ROUND((ST_XMax(int_symbol_geometry)-ST_XMin(int_symbol_geometry)) / NULLIF(!scale_denominator!*0.001*0.28,0)-1.5) END AS "int_width_viewpoint",
                  CASE WHEN int_symbol_geometry IS NOT NULL THEN ROUND((ST_YMax(int_symbol_geometry)-ST_YMin(int_symbol_geometry)) / NULLIF(!scale_denominator!*0.001*0.28,0)-1.5) END AS "int_height_viewpoint",
                  "icao",
                  "iata",
                  "drinking_water",
                  "intermittent",
                  "int_text_offset_tree",
                  "location",
                  "offshore",
                  "content",
                  "resource",
                  "int_lighthouse_type",
                  "telescope:type",
                  "crane:type",
                  "height",
                  "tower:type",
                  "int_tower_type",
                  "int_petroleum_well_type",
                  "memorial",
                  "castle_type",
                  "religion",
                  "shop",
                  "office",
                  "diplomatic",
                  "building",
                  way_area,
                  way_length,
                  way_pixels
                FROM
                (SELECT -- This subselect generates the feature column allows filtering on it
                    way,
                    carto_label_name(way, name, tags, E'\n') AS "_name_label",
                    "name",
                    "ref",
                    "operator",
                    "brand",
                    "osm_id",
                    COALESCE(
                      'aeroway_' || CASE WHEN "aeroway" IN ('aerodrome', 'helipad') AND (way_length IS NULL) THEN "aeroway" END,
                      'aeroway_' || CASE WHEN "aeroway" IN ('gate') AND (way_area IS NULL) AND (way_length IS NULL) THEN "aeroway" END,
                      'aeroway_' || CASE WHEN "aeroway" IN ('apron') AND (way_length IS NULL) AND (building IS NULL OR building = 'no') THEN "aeroway" END,
                      'railway_' || CASE WHEN "railway" IN ('crossing', 'halt', 'level_crossing', 'tram_stop') AND (way_area IS NULL) AND (way_length IS NULL) THEN "railway" END,
                      'railway_' || CASE WHEN "railway" IN ('station', 'subway_entrance') AND (way_length IS NULL) THEN "railway" END,
                      'highway_' || CASE WHEN "highway" IN ('bus_stop', 'traffic_signals') AND (way_area IS NULL) AND (way_length IS NULL) THEN "highway" END,
                      'highway_' || CASE WHEN "highway" IN ('elevator') AND (way_length IS NULL) AND ("access" IS NULL OR "access" NOT IN ('private', 'no', 'customers', 'permit', 'delivery')) THEN "highway" END,
                      'highway_' || CASE WHEN "highway" IN ('rest_area', 'services') AND (way_length IS NULL) AND (building IS NULL OR building = 'no') THEN "highway" END,
                      'natural_' || CASE WHEN "natural" IN ('bay', 'geyser', 'hot_spring', 'spring', 'volcano') AND (way_length IS NULL) THEN "natural" END,
                      'natural_' || CASE WHEN "natural" IN ('cave_entrance', 'saddle', 'tree') AND (way_area IS NULL) AND (way_length IS NULL) THEN "natural" END,
                      'natural_' || CASE WHEN "natural" IN ('peak') AND (way_area IS NULL) AND (way_length IS NULL) AND (tourism = 'viewpoint') THEN 'peak/viewpoint' END,
                      'natural_' || CASE WHEN "natural" IN ('peak') AND (way_area IS NULL) AND (way_length IS NULL) AND (tourism IS NULL OR tourism NOT IN ('viewpoint')) THEN "natural" END,
                      'natural_' || CASE WHEN "natural" IN ('bare_rock', 'beach', 'glacier', 'grassland', 'heath', 'mud', 'reef', 'sand', 'scree', 'scrub', 'shingle', 'shoal', 'water', 'wetland', 'wood') AND (way_length IS NULL) AND (building IS NULL OR building = 'no') THEN "natural" END,
                      'aerialway_' || CASE WHEN "aerialway" IN ('station') AND (way_length IS NULL) THEN "aerialway" END,
                      'tourism_' || CASE WHEN "tourism" IN ('alpine_hut', 'apartment', 'artwork', 'camp_site', 'caravan_site', 'charlet', 'guest_house', 'hostel', 'hotel', 'motel', 'museum', 'picnic_site', 'wilderness_hut') AND (way_length IS NULL) THEN "tourism" END,
                      'tourism_' || CASE WHEN "tourism" IN ('information') AND (way_length IS NULL) AND (tags->'information' IN ('audioguide', 'board', 'guidepost', 'map', 'office', 'sign', 'tactile_map', 'terminal', 'visitor_centre')) THEN "tourism" END,
                      'tourism_' || CASE WHEN "tourism" IN ('viewpoint') AND (way_area IS NULL) AND (way_length IS NULL) THEN "tourism" END,
                      'tourism_' || CASE WHEN "tourism" IN ('theme_park', 'zoo') AND (way_length IS NULL) AND (building IS NULL OR building = 'no') THEN "tourism" END,
                      'amenity_' || CASE WHEN "amenity" IN ('arts_centre', 'atm', 'bank', 'bar', 'bbq', 'bench', 'bicycle_parking', 'bicycle_rental', 'biergarten', 'bus_station', 'cafe', 'car_rental', 'car_wash', 'charging_station', 'cinema', 'clinic', 'community_centre', 'courthouse', 'dentist', 'doctors', 'driving_school', 'fast_food', 'ferry_terminal', 'fire_station', 'food_court', 'fountain', 'fuel', 'hospital', 'hunting_stand', 'ice_cream', 'library', 'lounger', 'marketplace', 'motorcycle_parking', 'nightclub', 'pharmacy', 'phone', 'place_of_worship', 'police', 'post_office', 'prison', 'pub', 'public_bath', 'recycling', 'restaurant', 'shelter', 'shower', 'social_facility', 'taxi', 'theatre', 'toilets', 'townhall', 'veterinary', 'waste_disposal') AND (way_length IS NULL) THEN "amenity" END,
                      'amenity_' || CASE WHEN "amenity" IN ('post_box', 'waste_basket', 'water_point') AND (way_area IS NULL) AND (way_length IS NULL) THEN "amenity" END,
                      'amenity_' || CASE WHEN "amenity" IN ('parking') AND (way_length IS NULL) AND ("parking" IS NULL OR "parking" NOT IN ('underground')) THEN "amenity" END,
                      'amenity_' || CASE WHEN "amenity" IN ('parking_entrance') AND (way_area IS NULL) AND (way_length IS NULL) AND ("parking" IN ('multi-storey') AND ("access" IS NULL OR "access" NOT IN ('private', 'no', 'permit', 'delivery'))) THEN 'parking_entrance/multi-storey' END,
                      'amenity_' || CASE WHEN "amenity" IN ('parking_entrance') AND (way_area IS NULL) AND (way_length IS NULL) AND ("parking" IN ('underground') AND ("access" IS NULL OR "access" NOT IN ('private', 'no', 'permit', 'delivery'))) THEN 'parking_entrance/underground' END,
                      'amenity_' || CASE WHEN "amenity" IN ('drinking_water') AND (way_area IS NULL) AND (way_length IS NULL) AND (("natural" IS NULL OR "natural" NOT IN ('spring', 'hot_spring')) AND (man_made IS NULL OR man_made NOT IN ('water_well'))) THEN "amenity" END,
                      'amenity_' || CASE WHEN "amenity" IN ('college', 'grave_yard', 'kindergarten', 'school', 'university') AND (way_length IS NULL) AND (building IS NULL OR building = 'no') THEN "amenity" END,
                      'office' || CASE WHEN (way_length IS NULL) AND (office IS NOT NULL AND office NOT IN ('yes', 'no', 'vacant', 'closed', 'disused', 'empty')) THEN '' END,
                      'advertising_' || CASE WHEN "advertising" IN ('column') AND (way_length IS NULL) THEN "advertising" END,
                      'emergency_' || CASE WHEN "emergency" IN ('life_ring', 'phone') AND (way_area IS NULL) AND (way_length IS NULL) THEN "emergency" END,
                      'shop_' || CASE WHEN "shop" IN ('mall', 'massage') AND (way_length IS NULL) THEN "shop" END,
                      'shop' || CASE WHEN (way_length IS NULL) AND (shop IS NOT NULL AND shop NOT IN ('yes', 'no', 'vacant', 'closed', 'disused', 'empty', 'mall', 'massage')) THEN '' END,
                      'leisure_' || CASE WHEN "leisure" IN ('beach_resort', 'firepit', 'golf_course', 'miniature_golf', 'picnic_table', 'playground', 'sauna', 'slipway', 'water_park') AND (way_length IS NULL) THEN "leisure" END,
                      'leisure_' || CASE WHEN "leisure" IN ('common', 'dog_park', 'fitness_centre', 'fitness_station', 'garden', 'marina', 'park', 'sport_centre', 'stadium', 'swimming_pool') AND (way_length IS NULL) AND (building IS NULL OR building = 'no') THEN "leisure" END,
                      'power_' || CASE WHEN "power" IN ('generator') AND (way_length IS NULL) AND (tags->'generator:source' = 'wind') THEN 'generator/wind' END,
                      'power_' || CASE WHEN "power" IN ('plant', 'substation') AND (way_length IS NULL) AND (building IS NULL OR building = 'no') THEN "power" END,
                      'power_' || CASE WHEN "power" IN ('generator') AND (way_length IS NULL) AND (tags->'generator:type' IS NULL OR tags->'generator:type' NOT IN ('wind')) THEN "power" END,
                      'man_made_' || CASE WHEN "man_made" IN ('cross', 'planter', 'water_tap', 'windpump') AND (way_area IS NULL) AND (way_length IS NULL) THEN "man_made" END,
                      'man_made_' || CASE WHEN "man_made" IN ('bridge', 'bunker_silo', 'communications_tower', 'crane', 'gasometer', 'heap', 'lighthouse', 'mast', 'obelisk', 'petroleum_well', 'reservoir_covered', 'silo', 'spoil_heap', 'storage_tank', 'telescope', 'tower', 'water_tower', 'water_well', 'watermill', 'windmill') AND (way_length IS NULL) THEN "man_made" END,
                      'man_made_' || CASE WHEN "man_made" IN ('works') AND (way_length IS NULL) AND (building IS NULL OR building = 'no') THEN "man_made" END,
                      'landuse_' || CASE WHEN "landuse" IN ('allotments', 'basin', 'brownfield', 'cemetery', 'commercial', 'construction', 'farmland', 'farmyard', 'forest', 'garages', 'grass', 'greenhouse_horticulture', 'industrial', 'landfill', 'meadow', 'military', 'quarry', 'railway', 'recreation_ground', 'reservoir', 'residential', 'retail', 'village_green') AND (way_length IS NULL) AND (building IS NULL OR building = 'no') THEN "landuse" END,
                      'waterway_' || CASE WHEN "waterway" IN ('waterfall') AND (way_length IS NULL) THEN "waterway" END,
                      'place_' || CASE WHEN "place" IN ('archipelago') AND (way_area IS NOT NULL) AND (way_length IS NULL) THEN "place" END,
                      'place_' || CASE WHEN "place" IN ('island', 'islet') AND (way_length IS NULL) THEN "place" END,
                      'historic_' || CASE WHEN "historic" IN ('archaeological_site', 'castle', 'city_gate', 'fort', 'manor', 'memorial', 'monument') AND (way_length IS NULL) THEN "historic" END,
                      'historic_' || CASE WHEN "historic" IN ('wayside_cross', 'wayside_shrine') AND (way_area IS NULL) AND (way_length IS NULL) THEN "historic" END,
                      'military_' || CASE WHEN "military" IN ('bunker') AND (way_length IS NULL) THEN "military" END,
                      'military_' || CASE WHEN "military" IN ('danger_area') AND (way_length IS NULL) AND (building IS NULL OR building = 'no') THEN "military" END,
                      'barrier_' || CASE WHEN "barrier" IN ('block', 'chain', 'gate', 'toll_booth') AND (way_length IS NULL) THEN "barrier" END,
                      'barrier_' || CASE WHEN "barrier" IN ('bollard', 'cattle_grid', 'cycle_barrier', 'full-height_turnstile', 'hampshire_gate', 'height_restrictor', 'kissing_gate', 'lift_gate', 'log', 'sliding_gate', 'stile', 'swing_gate', 'turnstile', 'wicket_gate') AND (way_area IS NULL) AND (way_length IS NULL) THEN "barrier" END
                    ) AS feature,
                    CASE
                      WHEN (("amenity" IN ('shelter')) AND (tags->'shelter_type' NOT IN ('public_transport') OR (tags->'shelter_type') IS NULL)) OR
                            ("tourism" IN ('alpine_hut', 'wilderness_hut') OR "natural" IN ('saddle', 'volcano')) OR
                            (("natural" IN ('peak')) AND (tourism = 'viewpoint')) OR
                            (("natural" IN ('peak')) AND (tourism IS NULL OR tourism NOT IN ('viewpoint'))) THEN
                        CASE WHEN (tags ? 'ele') AND tags->'ele' ~ '^-?\d{1,4}(\.\d+)?$' THEN CONCAT(E'\n', REPLACE(ROUND((tags->'ele')::NUMERIC)::TEXT, '-', U&'\2212'), U&'\00A0', 'm') END
                    END AS "int_elevation",
                    "shelter_type",
                    CASE
                      WHEN (("tourism" IN ('information')) AND (tags->'information' IN ('audioguide', 'board', 'guidepost', 'map', 'office', 'sign', 'tactile_map', 'terminal', 'visitor_centre'))) THEN "information"
                    END AS "information",
                    CASE
                      WHEN "amenity" IN ('bicycle_parking', 'motorcycle_parking', 'recycling', 'toilets', 'waste_disposal') OR "barrier" IN ('gate', 'lift_gate', 'sliding_gate', 'swing_gate', 'wicket_gate') OR "leisure" IN ('playground') OR
                            (("amenity" IN ('parking')) AND ("parking" IS NULL OR "parking" NOT IN ('underground'))) OR
                            (("amenity" IN ('parking_entrance')) AND ("parking" IN ('multi-storey') AND ("access" IS NULL OR "access" NOT IN ('private', 'no', 'permit', 'delivery')))) OR
                            (("amenity" IN ('parking_entrance')) AND ("parking" IN ('underground') AND ("access" IS NULL OR "access" NOT IN ('private', 'no', 'permit', 'delivery')))) OR
                            (("highway" IN ('elevator')) AND ("access" IS NULL OR "access" NOT IN ('private', 'no', 'customers', 'permit', 'delivery'))) THEN
                        CASE WHEN amenity IN ('parking', 'parking_entrance', 'bicycle_parking', 'motorcycle_parking') THEN
                          CASE WHEN "access" IN ('private', 'no', 'permit', 'delivery') THEN 'restricted' ELSE 'yes' END
                        ELSE
                          CASE WHEN "access" IN ('private', 'no', 'customers', 'permit', 'delivery') THEN 'restricted' ELSE 'yes' END
                        END
                    END AS "int_access",
                    CASE
                      WHEN (("amenity" IN ('parking')) AND ("parking" IS NULL OR "parking" NOT IN ('underground'))) OR
                            (("amenity" IN ('parking_entrance')) AND ("parking" IN ('multi-storey') AND ("access" IS NULL OR "access" NOT IN ('private', 'no', 'permit', 'delivery')))) OR
                            (("amenity" IN ('parking_entrance')) AND ("parking" IN ('underground') AND ("access" IS NULL OR "access" NOT IN ('private', 'no', 'permit', 'delivery')))) THEN "parking"
                    END AS "parking",
                    CASE
                      WHEN "amenity" IN ('bench') THEN
                        (CASE
                          WHEN "material" IN ('wood', 'plastic') THEN 'light'
                          WHEN "material" IN ('stone', 'concrete', 'metal', 'steel') THEN 'heavy'
                          ELSE 'unknown'
                        END || '+' || CASE
                          WHEN "backrest" IN ('yes') THEN 'backrest'
                          WHEN "backrest" IN ('no') THEN 'nobackrest'
                          ELSE 'unknown'
                        END)
                    END AS "int_bench_type",
                    "backrest",
                    "waste",
                    "recycling_type",
                    CASE
                      WHEN "barrier" IN ('gate') THEN
                        (CASE
                          WHEN "gate:type" IN ('sliding', 'rolling') THEN 'sliding'
                        END)
                    END AS "int_gate_type",
                    CASE
                      WHEN "barrier" IN ('cattle_grid', 'cycle_barrier', 'kissing_gate', 'log', 'turnstile') THEN
                        COALESCE(
                          (SELECT
                              CASE
                                WHEN direction BETWEEN 45 AND 135 THEN -90.0
                                WHEN direction BETWEEN 225 AND 315 THEN -90.0
                              END AS direction
                            FROM
                              (SELECT
                                  SUM(weight * (direction - floor(direction / 360.0) * 360.0))/SUM(weight) AS direction
                                FROM
                                  (SELECT
                                      CASE WHEN ST_IsCollection(way) THEN
                                        DEGREES(ST_Azimuth(ST_StartPoint(St_GeometryN(ST_CollectionExtract(way, 2), 1)), ST_EndPoint(St_GeometryN(ST_CollectionExtract(way, 2), 1))))
                                      ELSE
                                        DEGREES(ST_Azimuth(ST_StartPoint(way), ST_EndPoint(way)))
                                      END +
                                      CASE WHEN weight > 1.0 THEN 90.0 ELSE 0.0 END AS direction,
                                      weight
                                    FROM
                                      (SELECT
                                          ST_Intersection(line.way, ST_Expand(points_all.way, 0.1)) AS way,
                                          CASE
                                            WHEN line.barrier IN ('chain', 'city_wall', 'ditch', 'fence', 'guard_rail',
                                                                  'handrail', 'retaining_wall', 'wall') THEN 10.0
                                            ELSE 1.0
                                          END AS weight
                                        FROM planet_osm_line line
                                        WHERE ST_DWithin(line.way, points_all.way, 0.1)
                                          AND (
                                            line.barrier IN ('chain', 'city_wall', 'ditch', 'fence', 'guard_rail',
                                                             'handrail', 'retaining_wall', 'wall') OR
                                            line.highway IN ('motorway', 'motorway_link', 'trunk', 'trunk_link', 'primary', 'primary_link', 'secondary',
                                                             'secondary_link', 'tertiary', 'tertiary_link', 'residential', 'unclassified', 'service',
                                                             'living_street', 'pedestrian', 'steps', 'road', 'bridleway', 'footway', 'cycleway', 'path',
                                                             'track', 'busway', 'bus_guideway')
                                          )
                        
                                      ) AS lines_raw
                                  ) AS directions
                              ) AS direction_avg
                          ),
                          0.0
                        )
                    END AS "int_barrier_orientation",
                    "stile",
                    "kissing_gate",
                    CASE
                      WHEN "barrier" IN ('height_restrictor') THEN
                        CASE WHEN (tags ? 'maxheight') AND tags->'maxheight' ~ '^-?\d{1,4}(\.\d+)?$' THEN CONCAT(TO_CHAR((tags->'maxheight')::NUMERIC, 'FM90.0'), 'm') END
                    END AS "int_maxheight",
                    CASE
                      WHEN "tourism" IN ('viewpoint') OR
                            (("natural" IN ('peak')) AND (tourism = 'viewpoint')) THEN
                        (SELECT
                            ST_Translate(
                              carto_viewpoint_symbol_from_db(
                                'viewpoint',
                                width,
                                width_px,
                                azimuth,
                                angle
                              ),
                              ST_X(point),
                              ST_Y(point)
                            ) AS way
                          FROM
                            (SELECT
                                CASE WHEN ((width_px % 2) = 0) THEN
                                  ST_SnapToGrid(
                                    way,
                                    NULLIF(!scale_denominator!*0.001*0.28,0), NULLIF(!scale_denominator!*0.001*0.28,0))
                                ELSE
                                  ST_SnapToGrid(
                                    way,
                                    0.5*NULLIF(!scale_denominator!*0.001*0.28,0), 0.5*NULLIF(!scale_denominator!*0.001*0.28,0),
                                    NULLIF(!scale_denominator!*0.001*0.28,0), NULLIF(!scale_denominator!*0.001*0.28,0))
                                END AS point,
                                view_geometry[1] AS azimuth,
                                view_geometry[2] AS angle,
                                width_px,
                                width_px*NULLIF(!scale_denominator!*0.001*0.28,0) AS width
                              FROM
                                (SELECT
                                    way,
                                    osm_id AS hash,
                                    CASE WHEN (tags ? 'ele') AND tags->'ele' ~ '^-?\d{1,4}(\.\d+)?$' THEN 
                                      (tags->'ele')::NUMERIC
                                    ELSE
                                      -100000.0
                                    END AS elevation,
                                    carto_viewpoint_direction(tags->'direction') AS view_geometry,
                                    carto_barrier_line_width('viewpoint', z(!scale_denominator!)) AS width_px) AS t1
                            ) AS viewpoints_raw
                          WHERE width_px >= 10
                        )
                    END AS "int_symbol_geometry",
                    "icao",
                    "iata",
                    CASE WHEN amenity = 'drinking_water' OR (tags->'drinking_water') = 'yes' THEN 'yes' END AS "drinking_water",
                    CASE
                      WHEN "natural" IN ('hot_spring', 'spring') THEN
                        CASE WHEN tags->'intermittent' IN ('yes') OR tags->'seasonal' IN ('yes') THEN 'yes' END
                    END AS "intermittent",
                    CASE
                      WHEN "natural" IN ('tree') THEN
                        ROUND(GREATEST(
                          carto_barrier_line_width('tree', z(!scale_denominator!)),
                          LEAST(carto_tree_diameter_mapped('tree', diameter_crown, height, circumference, diameter, !bbox!, !scale_denominator!), 60)
                        )*0.5)+2.0
                    END AS "int_text_offset_tree",
                    CASE
                      WHEN (("power" IN ('generator')) AND (tags->'generator:source' = 'wind')) THEN "location"
                    END AS "location",
                    CASE
                      WHEN (("power" IN ('generator')) AND (tags->'generator:source' = 'wind')) THEN "offshore"
                    END AS "offshore",
                    "content",
                    "resource",
                    CASE
                      WHEN "man_made" IN ('lighthouse') THEN
                        (CASE
                          WHEN "seamark:type" IN ('light_major', 'light_minor') THEN 'active' ELSE 'inactive'
                        END) || (CASE
                          WHEN "seamark:light:character" IS NOT NULL AND "seamark:light:character" != 'F' THEN '+variable'
                        ELSE
                          ''
                        END)
                    END AS "int_lighthouse_type",
                    "telescope:type",
                    "crane:type",
                    CASE
                      WHEN (("man_made" IN ('mast', 'tower')) AND (tags->'location' NOT IN ('roof', 'rooftop') OR (tags->'location') IS NULL)) OR
                            ("waterway" IN ('waterfall')) THEN
                        CASE WHEN height ~ '^\d{1,3}(\.\d+)?( m)?$' THEN (SUBSTRING(height, '^(\d{1,3}(\.\d+)?)( m)?$'))::NUMERIC END
                    END AS "height",
                    "tower:type",
                    CASE
                      WHEN "man_made" IN ('mast', 'tower') THEN
                        (CASE
                          WHEN man_made = 'tower' THEN
                            (CASE
                              WHEN "tower:type" IN ('bell_tower') THEN
                                'bell_tower' ||
                                (CASE WHEN "roof:shape" IN ('flat', 'gabled', 'hipped', 'pyramidal') THEN '+' || "roof:shape" ELSE '' END) ||
                                (CASE WHEN "tower:construction" IN ('lattice') THEN '+' || "tower:construction" ELSE '' END)
                            ELSE
                              (CASE
                                WHEN "tower:construction" IN ('dish', 'dome', 'freestanding', 'lattice') THEN "tower:construction" ELSE 'unknown'
                              END) ||
                              (CASE
                                WHEN "tower:construction" IN ('dish', 'dome') THEN
                                  -- dish and dome are only allowed with communication/radar
                                  (CASE
                                    WHEN "tower:type" IN ('communication', 'radar') THEN '+' || "tower:type"
                                  ELSE ''
                                  END)
                              ELSE
                                  (CASE
                                    WHEN "tower:type" IN ('cooling', 'communication', 'defensive', 'lighting', 'minaret', 'observation', 'radar', 'siren', 'watchtower') THEN '+' || "tower:type"
                                  ELSE ''
                                  END)
                              END)
                            END)
                          WHEN man_made = 'mast' THEN
                            (CASE
                              WHEN "tower:construction" IN ('freestanding', 'guyed_lattice', 'guyed_tube', 'lattice') THEN "tower:construction" ELSE 'unknown'
                            END) ||
                            (CASE
                              WHEN "tower:type" IN ('communication', 'lighting', 'radar', 'siren') THEN '+' || "tower:type" ELSE ''
                            END)
                        END)
                    END AS "int_tower_type",
                    CASE
                      WHEN "man_made" IN ('petroleum_well') THEN
                        (CASE
                          WHEN pump = 'yes' THEN (CASE WHEN disused = 'yes' THEN 'disused+pump' ELSE 'pump' END)
                        ELSE
                          (CASE
                            WHEN disused = 'yes' THEN (CASE WHEN substance IN ('oil', 'gas') THEN 'disused+' || substance ELSE 'disused' END)
                          ELSE
                            (CASE WHEN substance IN ('oil', 'gas') THEN substance END)
                          END)
                        END)
                    END AS "int_petroleum_well_type",
                    "memorial",
                    "castle_type",
                    CASE
                      WHEN "amenity" IN ('place_of_worship') THEN
                        CASE WHEN religion IN ('christian') AND tags->'denomination' IN ('jehovahs_witness', 'la_luz_del_mundo', 'iglesia_ni_cristo', 'mormon') THEN NULL ELSE religion END
                    END AS "religion",
                    CASE
                      WHEN (("shop" IN ('massage')) AND (shop IS NOT NULL AND shop NOT IN ('yes', 'no', 'vacant', 'closed', 'disused', 'empty', 'mall', 'massage'))) THEN
                        CASE WHEN shop IN ('supermarket', 'bag', 'bakery', 'beauty', 'bed', 'bookmaker', 'books', 'butcher', 'carpet', 'clothes', 'computer',
                                           'confectionery', 'fashion', 'convenience', 'department_store', 'doityourself', 'hardware', 'fabric', 'fishmonger', 'florist',
                                           'garden_centre', 'hairdresser', 'hifi', 'car', 'car_repair', 'bicycle', 'mall', 'pet',
                                           'photo', 'photo_studio', 'photography', 'seafood', 'shoes', 'alcohol', 'gift', 'furniture', 'kiosk',
                                           'mobile_phone', 'motorcycle', 'musical_instrument', 'newsagent', 'optician', 'jewelry', 'jewellery',
                                           'electronics', 'chemist', 'toys', 'travel_agency', 'car_parts', 'greengrocer', 'farm', 'stationery',
                                           'laundry', 'dry_cleaning', 'beverages', 'perfumery', 'cosmetics', 'variety_store', 'wine', 'outdoor',
                                           'copyshop', 'sports', 'deli', 'tobacco', 'art', 'tea', 'coffee', 'tyres', 'pastry', 'chocolate',
                                           'music', 'medical_supply', 'dairy', 'video_games', 'houseware', 'ticket', 'charity', 'second_hand',
                                           'interior_decoration', 'video', 'paint', 'massage', 'trade', 'wholesale') THEN shop
                          ELSE 'other' END
                    END AS "shop",
                    CASE
                      WHEN (("office" IN ('column')) AND (office IS NOT NULL AND office NOT IN ('yes', 'no', 'vacant', 'closed', 'disused', 'empty'))) THEN "office"
                    END AS "office",
                    CASE
                      WHEN (("office" IN ('column')) AND (office IS NOT NULL AND office NOT IN ('yes', 'no', 'vacant', 'closed', 'disused', 'empty'))) THEN "diplomatic"
                    END AS "diplomatic",
                    CASE
                      WHEN (("leisure" IN ('common', 'dog_park', 'fitness_centre', 'fitness_station', 'garden', 'marina', 'park', 'sport_centre', 'stadium', 'swimming_pool') OR "landuse" IN ('allotments', 'basin', 'brownfield', 'cemetery', 'commercial', 'construction', 'farmland', 'farmyard', 'forest', 'garages', 'grass', 'greenhouse_horticulture', 'industrial', 'landfill', 'meadow', 'military', 'quarry', 'railway', 'recreation_ground', 'reservoir', 'residential', 'retail', 'village_green') OR "military" IN ('danger_area') OR "highway" IN ('rest_area', 'services') OR "man_made" IN ('works') OR "amenity" IN ('college', 'grave_yard', 'kindergarten', 'school', 'university') OR "natural" IN ('bare_rock', 'beach', 'glacier', 'grassland', 'heath', 'mud', 'reef', 'sand', 'scree', 'scrub', 'shingle', 'shoal', 'water', 'wetland', 'wood') OR "tourism" IN ('theme_park', 'zoo') OR "power" IN ('plant', 'substation') OR "aeroway" IN ('apron')) AND (building IS NULL OR building = 'no')) OR
                            (("power" IN ('generator')) AND (tags->'generator:type' IS NULL OR tags->'generator:type' NOT IN ('wind'))) THEN "building"
                    END AS "building",
                    way_length,
                    way_area,
                    COALESCE(way_area/NULLIF(POW(!scale_denominator!*0.001*0.28,2),0), 0) AS way_pixels
                  FROM
                  (
                    SELECT
                        way,
                        "access",
                        "aerialway",
                        "aeroway",
                        "amenity",
                        "barrier",
                        "building",
                        "highway",
                        "historic",
                        "landuse",
                        "leisure",
                        "man_made",
                        "military",
                        "name",
                        "natural",
                        "osm_id",
                        "place",
                        "power",
                        "railway",
                        "ref",
                        "religion",
                        "shop",
                        "tourism",
                        "waterway",
                        tags->'advertising' AS "advertising",
                        tags->'backrest' AS "backrest",
                        tags->'brand' AS "brand",
                        tags->'castle_type' AS "castle_type",
                        tags->'circumference' AS "circumference",
                        tags->'content' AS "content",
                        tags->'crane:type' AS "crane:type",
                        tags->'diameter' AS "diameter",
                        tags->'diameter_crown' AS "diameter_crown",
                        tags->'diplomatic' AS "diplomatic",
                        tags->'disused' AS "disused",
                        tags->'drinking_water' AS "drinking_water",
                        tags->'emergency' AS "emergency",
                        tags->'gate:type' AS "gate:type",
                        tags->'height' AS "height",
                        tags->'iata' AS "iata",
                        tags->'icao' AS "icao",
                        tags->'information' AS "information",
                        tags->'intermittent' AS "intermittent",
                        tags->'kissing_gate' AS "kissing_gate",
                        tags->'location' AS "location",
                        tags->'material' AS "material",
                        tags->'memorial' AS "memorial",
                        tags->'office' AS "office",
                        tags->'offshore' AS "offshore",
                        tags->'operator' AS "operator",
                        tags->'parking' AS "parking",
                        tags->'pump' AS "pump",
                        tags->'recycling_type' AS "recycling_type",
                        tags->'resource' AS "resource",
                        tags->'roof:shape' AS "roof:shape",
                        tags->'seamark:light:character' AS "seamark:light:character",
                        tags->'seamark:type' AS "seamark:type",
                        tags->'shelter_type' AS "shelter_type",
                        tags->'stile' AS "stile",
                        tags->'substance' AS "substance",
                        tags->'telescope:type' AS "telescope:type",
                        tags->'tower:construction' AS "tower:construction",
                        tags->'tower:type' AS "tower:type",
                        tags->'waste' AS "waste",
                        tags,
                        NULL AS way_length,
                        NULL AS way_area
                      FROM planet_osm_point
                      WHERE way && !bbox! AND
                        CASE
                          WHEN z(!scale_denominator!) <= 9 THEN FALSE
                          WHEN z(!scale_denominator!) <= 10 THEN
                            ("aeroway" IN ('aerodrome', 'apron')) OR
                            ("leisure" IN ('common', 'dog_park', 'fitness_centre', 'fitness_station', 'garden', 'park', 'sport_centre', 'stadium')) OR
                            ("shop" IN ('mall')) OR
                            ("place" IN ('island')) OR
                            ("landuse" IN ('allotments', 'basin', 'brownfield', 'cemetery', 'commercial', 'construction', 'farmland', 'farmyard', 'forest', 'grass', 'greenhouse_horticulture', 'landfill', 'meadow', 'military', 'quarry', 'recreation_ground', 'reservoir', 'village_green')) OR
                            ("military" IN ('danger_area')) OR
                            ("amenity" IN ('college', 'grave_yard', 'kindergarten', 'school', 'university')) OR
                            ("natural" IN ('bare_rock', 'beach', 'glacier', 'grassland', 'heath', 'mud', 'reef', 'sand', 'scree', 'scrub', 'shingle', 'shoal', 'water', 'wetland', 'wood')) OR
                            ("tourism" IN ('theme_park', 'zoo')) OR
                            ("power" IN ('generator', 'plant'))
                          WHEN z(!scale_denominator!) <= 11 THEN
                            ("aeroway" IN ('aerodrome', 'apron')) OR
                            ("leisure" IN ('common', 'dog_park', 'fitness_centre', 'fitness_station', 'garden', 'park', 'sport_centre', 'stadium')) OR
                            ("shop" IN ('mall')) OR
                            ("place" IN ('island', 'islet')) OR
                            ("landuse" IN ('allotments', 'basin', 'brownfield', 'cemetery', 'commercial', 'construction', 'farmland', 'farmyard', 'forest', 'grass', 'greenhouse_horticulture', 'landfill', 'meadow', 'military', 'quarry', 'recreation_ground', 'reservoir', 'village_green')) OR
                            ("military" IN ('danger_area')) OR
                            ("amenity" IN ('college', 'grave_yard', 'kindergarten', 'school', 'university')) OR
                            ("natural" IN ('bare_rock', 'beach', 'glacier', 'grassland', 'heath', 'mud', 'peak', 'reef', 'sand', 'scree', 'scrub', 'shingle', 'shoal', 'water', 'wetland', 'wood')) OR
                            ("tourism" IN ('theme_park', 'zoo')) OR
                            ("power" IN ('generator', 'plant'))
                          WHEN z(!scale_denominator!) <= 12 THEN
                            ("aeroway" IN ('aerodrome', 'apron')) OR
                            ("leisure" IN ('common', 'dog_park', 'fitness_centre', 'fitness_station', 'garden', 'park', 'sport_centre', 'stadium')) OR
                            ("shop" IN ('mall')) OR
                            ("place" IN ('island', 'islet')) OR
                            ("landuse" IN ('allotments', 'basin', 'brownfield', 'cemetery', 'commercial', 'construction', 'farmland', 'farmyard', 'forest', 'grass', 'greenhouse_horticulture', 'landfill', 'meadow', 'military', 'quarry', 'recreation_ground', 'reservoir', 'village_green')) OR
                            ("military" IN ('danger_area')) OR
                            ("amenity" IN ('college', 'grave_yard', 'kindergarten', 'school', 'university')) OR
                            ("natural" IN ('bare_rock', 'beach', 'glacier', 'grassland', 'heath', 'mud', 'peak', 'reef', 'sand', 'scree', 'scrub', 'shingle', 'shoal', 'water', 'wetland', 'wood')) OR
                            ("tourism" IN ('theme_park', 'zoo')) OR
                            ("power" IN ('generator', 'plant')) OR
                            ("railway" IN ('station')) OR
                            ("man_made" IN ('bridge'))
                          WHEN z(!scale_denominator!) <= 13 THEN
                            ("aeroway" IN ('aerodrome', 'apron')) OR
                            ("leisure" IN ('common', 'dog_park', 'fitness_centre', 'fitness_station', 'garden', 'park', 'sport_centre', 'stadium')) OR
                            ("shop" IN ('mall')) OR
                            ("place" IN ('island', 'islet')) OR
                            ("landuse" IN ('allotments', 'basin', 'brownfield', 'cemetery', 'commercial', 'construction', 'farmland', 'farmyard', 'forest', 'garages', 'grass', 'greenhouse_horticulture', 'industrial', 'landfill', 'meadow', 'military', 'quarry', 'railway', 'recreation_ground', 'reservoir', 'residential', 'retail', 'village_green')) OR
                            ("military" IN ('danger_area')) OR
                            ("amenity" IN ('college', 'grave_yard', 'kindergarten', 'school', 'university')) OR
                            ("natural" IN ('bare_rock', 'beach', 'glacier', 'grassland', 'heath', 'mud', 'peak', 'reef', 'sand', 'scree', 'scrub', 'shingle', 'shoal', 'volcano', 'water', 'wetland', 'wood')) OR
                            ("tourism" IN ('alpine_hut', 'theme_park', 'wilderness_hut', 'zoo')) OR
                            ("power" IN ('generator', 'plant', 'substation')) OR
                            ("railway" IN ('halt', 'station', 'tram_stop')) OR
                            ("man_made" IN ('bridge', 'works')) OR
                            ("aerialway" IN ('station')) OR
                            ("highway" IN ('rest_area', 'services'))
                          WHEN z(!scale_denominator!) <= 14 THEN
                            ("aeroway" IN ('aerodrome', 'apron')) OR
                            ("leisure" IN ('common', 'dog_park', 'fitness_centre', 'fitness_station', 'garden', 'park', 'sport_centre', 'stadium', 'swimming_pool', 'water_park')) OR
                            ("shop" IN ('mall')) OR
                            ("place" IN ('island', 'islet')) OR
                            ("landuse" IN ('allotments', 'basin', 'brownfield', 'cemetery', 'commercial', 'construction', 'farmland', 'farmyard', 'forest', 'garages', 'grass', 'greenhouse_horticulture', 'industrial', 'landfill', 'meadow', 'military', 'quarry', 'railway', 'recreation_ground', 'reservoir', 'residential', 'retail', 'village_green')) OR
                            ("military" IN ('danger_area')) OR
                            ("amenity" IN ('bicycle_parking', 'college', 'grave_yard', 'kindergarten', 'motorcycle_parking', 'parking', 'school', 'university')) OR
                            ("natural" IN ('bare_rock', 'bay', 'beach', 'geyser', 'glacier', 'grassland', 'heath', 'hot_spring', 'mud', 'peak', 'reef', 'sand', 'scree', 'scrub', 'shingle', 'shoal', 'spring', 'volcano', 'water', 'wetland', 'wood')) OR
                            ("tourism" IN ('alpine_hut', 'theme_park', 'wilderness_hut', 'zoo')) OR
                            ("power" IN ('generator', 'plant', 'substation')) OR
                            ("railway" IN ('halt', 'level_crossing', 'station', 'tram_stop')) OR
                            ("man_made" IN ('bridge', 'communications_tower', 'mast', 'tower', 'works')) OR
                            ("aerialway" IN ('station')) OR
                            ("highway" IN ('rest_area', 'services'))
                          WHEN z(!scale_denominator!) <= 15 THEN
                            ("aeroway" IN ('aerodrome', 'apron')) OR
                            ("leisure" IN ('common', 'dog_park', 'fitness_centre', 'fitness_station', 'garden', 'golf_course', 'marina', 'park', 'sport_centre', 'stadium', 'swimming_pool', 'water_park')) OR
                            ("shop" IN ('mall')) OR
                            ("place" IN ('island', 'islet')) OR
                            ("landuse" IN ('allotments', 'basin', 'brownfield', 'cemetery', 'commercial', 'construction', 'farmland', 'farmyard', 'forest', 'garages', 'grass', 'greenhouse_horticulture', 'industrial', 'landfill', 'meadow', 'military', 'quarry', 'railway', 'recreation_ground', 'reservoir', 'residential', 'retail', 'village_green')) OR
                            ("military" IN ('danger_area')) OR
                            ("amenity" IN ('bicycle_parking', 'college', 'ferry_terminal', 'grave_yard', 'hospital', 'kindergarten', 'motorcycle_parking', 'parking', 'school', 'university')) OR
                            ("natural" IN ('bare_rock', 'bay', 'beach', 'cave_entrance', 'geyser', 'glacier', 'grassland', 'heath', 'hot_spring', 'mud', 'peak', 'reef', 'saddle', 'sand', 'scree', 'scrub', 'shingle', 'shoal', 'spring', 'volcano', 'water', 'wetland', 'wood')) OR
                            ("tourism" IN ('alpine_hut', 'theme_park', 'wilderness_hut', 'zoo')) OR
                            ("power" IN ('generator', 'plant', 'substation')) OR
                            ("railway" IN ('crossing', 'halt', 'level_crossing', 'station', 'tram_stop')) OR
                            ("man_made" IN ('bridge', 'communications_tower', 'gasometer', 'heap', 'lighthouse', 'mast', 'spoil_heap', 'tower', 'water_well', 'works')) OR
                            ("aerialway" IN ('station')) OR
                            ("highway" IN ('rest_area', 'services')) OR
                            ("historic" IN ('castle'))
                          WHEN z(!scale_denominator!) <= 16 THEN
                            ("aeroway" IN ('aerodrome', 'apron', 'helipad')) OR
                            ("leisure" IN ('beach_resort', 'common', 'dog_park', 'fitness_centre', 'fitness_station', 'garden', 'golf_course', 'marina', 'park', 'sport_centre', 'stadium', 'swimming_pool', 'water_park')) OR
                            ("shop" IS NOT NULL) OR
                            ("place" IN ('island', 'islet')) OR
                            ("landuse" IN ('allotments', 'basin', 'brownfield', 'cemetery', 'commercial', 'construction', 'farmland', 'farmyard', 'forest', 'garages', 'grass', 'greenhouse_horticulture', 'industrial', 'landfill', 'meadow', 'military', 'quarry', 'railway', 'recreation_ground', 'reservoir', 'residential', 'retail', 'village_green')) OR
                            ("military" IN ('danger_area')) OR
                            ("amenity" IN ('bicycle_parking', 'bus_station', 'cinema', 'clinic', 'college', 'courthouse', 'ferry_terminal', 'fire_station', 'grave_yard', 'hospital', 'hunting_stand', 'kindergarten', 'library', 'marketplace', 'motorcycle_parking', 'parking', 'place_of_worship', 'police', 'school', 'shelter', 'theatre', 'townhall', 'university')) OR
                            ("natural" IN ('bare_rock', 'bay', 'beach', 'cave_entrance', 'geyser', 'glacier', 'grassland', 'heath', 'hot_spring', 'mud', 'peak', 'reef', 'saddle', 'sand', 'scree', 'scrub', 'shingle', 'shoal', 'spring', 'volcano', 'water', 'wetland', 'wood')) OR
                            ("tourism" IN ('alpine_hut', 'museum', 'picnic_site', 'theme_park', 'viewpoint', 'wilderness_hut', 'zoo')) OR
                            ("power" IN ('generator', 'plant', 'substation')) OR
                            ("railway" IN ('crossing', 'halt', 'level_crossing', 'station', 'tram_stop')) OR
                            ("man_made" IN ('bridge', 'bunker_silo', 'communications_tower', 'cross', 'gasometer', 'heap', 'lighthouse', 'mast', 'silo', 'spoil_heap', 'storage_tank', 'tower', 'water_well', 'windmill', 'windpump', 'works')) OR
                            ("aerialway" IN ('station')) OR
                            ("highway" IN ('bus_stop', 'rest_area', 'services')) OR
                            ("historic" IN ('archaeological_site', 'castle', 'fort', 'manor', 'monument', 'wayside_cross', 'wayside_shrine')) OR
                            ("barrier" IN ('toll_booth'))
                          WHEN z(!scale_denominator!) <= 17 THEN
                            ("aeroway" IN ('aerodrome', 'apron', 'gate', 'helipad')) OR
                            ("leisure" IN ('beach_resort', 'common', 'dog_park', 'firepit', 'fitness_centre', 'fitness_station', 'garden', 'golf_course', 'marina', 'miniature_golf', 'park', 'picnic_table', 'playground', 'sauna', 'slipway', 'sport_centre', 'stadium', 'swimming_pool', 'water_park')) OR
                            ("shop" IS NOT NULL) OR
                            ("place" IN ('island', 'islet')) OR
                            ("landuse" IN ('allotments', 'basin', 'brownfield', 'cemetery', 'commercial', 'construction', 'farmland', 'farmyard', 'forest', 'garages', 'grass', 'greenhouse_horticulture', 'industrial', 'landfill', 'meadow', 'military', 'quarry', 'railway', 'recreation_ground', 'reservoir', 'residential', 'retail', 'village_green')) OR
                            ("military" IN ('bunker', 'danger_area')) OR
                            ("amenity" IN ('arts_centre', 'atm', 'bank', 'bar', 'bbq', 'bicycle_parking', 'bicycle_rental', 'biergarten', 'bus_station', 'cafe', 'car_rental', 'car_wash', 'charging_station', 'cinema', 'clinic', 'college', 'community_centre', 'courthouse', 'dentist', 'doctors', 'drinking_water', 'driving_school', 'fast_food', 'ferry_terminal', 'fire_station', 'food_court', 'fountain', 'fuel', 'grave_yard', 'hospital', 'hunting_stand', 'ice_cream', 'kindergarten', 'library', 'marketplace', 'motorcycle_parking', 'nightclub', 'parking', 'pharmacy', 'phone', 'place_of_worship', 'police', 'post_box', 'post_office', 'prison', 'pub', 'public_bath', 'recycling', 'restaurant', 'school', 'shelter', 'social_facility', 'taxi', 'theatre', 'toilets', 'townhall', 'university', 'veterinary', 'water_point')) OR
                            ("natural" IN ('bare_rock', 'bay', 'beach', 'cave_entrance', 'geyser', 'glacier', 'grassland', 'heath', 'hot_spring', 'mud', 'peak', 'reef', 'saddle', 'sand', 'scree', 'scrub', 'shingle', 'shoal', 'spring', 'tree', 'volcano', 'water', 'wetland', 'wood')) OR
                            ("tourism" IN ('alpine_hut', 'artwork', 'camp_site', 'caravan_site', 'charlet', 'guest_house', 'hostel', 'hotel', 'information', 'motel', 'museum', 'picnic_site', 'theme_park', 'viewpoint', 'wilderness_hut', 'zoo')) OR
                            ("power" IN ('generator', 'plant', 'substation')) OR
                            ("railway" IN ('crossing', 'halt', 'level_crossing', 'station', 'tram_stop')) OR
                            ("man_made" IN ('bridge', 'bunker_silo', 'communications_tower', 'crane', 'cross', 'gasometer', 'heap', 'lighthouse', 'mast', 'obelisk', 'petroleum_well', 'reservoir_covered', 'silo', 'spoil_heap', 'storage_tank', 'telescope', 'tower', 'water_tap', 'water_tower', 'water_well', 'watermill', 'windmill', 'windpump', 'works')) OR
                            ("aerialway" IN ('station')) OR
                            ("highway" IN ('bus_stop', 'rest_area', 'services', 'traffic_signals')) OR
                            ("historic" IN ('archaeological_site', 'castle', 'city_gate', 'fort', 'manor', 'memorial', 'monument', 'wayside_cross', 'wayside_shrine')) OR
                            ("barrier" IN ('block', 'bollard', 'cattle_grid', 'full-height_turnstile', 'gate', 'hampshire_gate', 'kissing_gate', 'lift_gate', 'log', 'sliding_gate', 'stile', 'swing_gate', 'toll_booth', 'turnstile')) OR
                            ((tags->'office') IS NOT NULL)
                          WHEN z(!scale_denominator!) <= 18 THEN
                            ("aeroway" IN ('aerodrome', 'apron', 'gate', 'helipad')) OR
                            ("leisure" IN ('beach_resort', 'common', 'dog_park', 'firepit', 'fitness_centre', 'fitness_station', 'garden', 'golf_course', 'marina', 'miniature_golf', 'park', 'picnic_table', 'playground', 'sauna', 'slipway', 'sport_centre', 'stadium', 'swimming_pool', 'water_park')) OR
                            ("shop" IS NOT NULL) OR
                            ("place" IN ('island', 'islet')) OR
                            ("landuse" IN ('allotments', 'basin', 'brownfield', 'cemetery', 'commercial', 'construction', 'farmland', 'farmyard', 'forest', 'garages', 'grass', 'greenhouse_horticulture', 'industrial', 'landfill', 'meadow', 'military', 'quarry', 'railway', 'recreation_ground', 'reservoir', 'residential', 'retail', 'village_green')) OR
                            ("military" IN ('bunker', 'danger_area')) OR
                            ("amenity" IN ('arts_centre', 'atm', 'bank', 'bar', 'bbq', 'bench', 'bicycle_parking', 'bicycle_rental', 'biergarten', 'bus_station', 'cafe', 'car_rental', 'car_wash', 'charging_station', 'cinema', 'clinic', 'college', 'community_centre', 'courthouse', 'dentist', 'doctors', 'drinking_water', 'driving_school', 'fast_food', 'ferry_terminal', 'fire_station', 'food_court', 'fountain', 'fuel', 'grave_yard', 'hospital', 'hunting_stand', 'ice_cream', 'kindergarten', 'library', 'lounger', 'marketplace', 'motorcycle_parking', 'nightclub', 'parking', 'parking_entrance', 'pharmacy', 'phone', 'place_of_worship', 'police', 'post_box', 'post_office', 'prison', 'pub', 'public_bath', 'recycling', 'restaurant', 'school', 'shelter', 'shower', 'social_facility', 'taxi', 'theatre', 'toilets', 'townhall', 'university', 'veterinary', 'waste_disposal', 'water_point')) OR
                            ("natural" IN ('bare_rock', 'bay', 'beach', 'cave_entrance', 'geyser', 'glacier', 'grassland', 'heath', 'hot_spring', 'mud', 'peak', 'reef', 'saddle', 'sand', 'scree', 'scrub', 'shingle', 'shoal', 'spring', 'tree', 'volcano', 'water', 'wetland', 'wood')) OR
                            ("tourism" IN ('alpine_hut', 'apartment', 'artwork', 'camp_site', 'caravan_site', 'charlet', 'guest_house', 'hostel', 'hotel', 'information', 'motel', 'museum', 'picnic_site', 'theme_park', 'viewpoint', 'wilderness_hut', 'zoo')) OR
                            ("power" IN ('generator', 'plant', 'substation')) OR
                            ("railway" IN ('crossing', 'halt', 'level_crossing', 'station', 'subway_entrance', 'tram_stop')) OR
                            ("man_made" IN ('bridge', 'bunker_silo', 'communications_tower', 'crane', 'cross', 'gasometer', 'heap', 'lighthouse', 'mast', 'obelisk', 'petroleum_well', 'planter', 'reservoir_covered', 'silo', 'spoil_heap', 'storage_tank', 'telescope', 'tower', 'water_tap', 'water_tower', 'water_well', 'watermill', 'windmill', 'windpump', 'works')) OR
                            ("aerialway" IN ('station')) OR
                            ("highway" IN ('bus_stop', 'elevator', 'rest_area', 'services', 'traffic_signals')) OR
                            ("historic" IN ('archaeological_site', 'castle', 'city_gate', 'fort', 'manor', 'memorial', 'monument', 'wayside_cross', 'wayside_shrine')) OR
                            ("barrier" IN ('block', 'bollard', 'cattle_grid', 'chain', 'cycle_barrier', 'full-height_turnstile', 'gate', 'hampshire_gate', 'height_restrictor', 'kissing_gate', 'lift_gate', 'log', 'sliding_gate', 'stile', 'swing_gate', 'toll_booth', 'turnstile')) OR
                            ((tags->'office') IS NOT NULL)
                          ELSE
                            ("aeroway" IN ('aerodrome', 'apron', 'gate', 'helipad')) OR
                            ("leisure" IN ('beach_resort', 'common', 'dog_park', 'firepit', 'fitness_centre', 'fitness_station', 'garden', 'golf_course', 'marina', 'miniature_golf', 'park', 'picnic_table', 'playground', 'sauna', 'slipway', 'sport_centre', 'stadium', 'swimming_pool', 'water_park')) OR
                            ("shop" IS NOT NULL) OR
                            ("place" IN ('island', 'islet')) OR
                            ("landuse" IN ('allotments', 'basin', 'brownfield', 'cemetery', 'commercial', 'construction', 'farmland', 'farmyard', 'forest', 'garages', 'grass', 'greenhouse_horticulture', 'industrial', 'landfill', 'meadow', 'military', 'quarry', 'railway', 'recreation_ground', 'reservoir', 'residential', 'retail', 'village_green')) OR
                            ("military" IN ('bunker', 'danger_area')) OR
                            ("amenity" IN ('arts_centre', 'atm', 'bank', 'bar', 'bbq', 'bench', 'bicycle_parking', 'bicycle_rental', 'biergarten', 'bus_station', 'cafe', 'car_rental', 'car_wash', 'charging_station', 'cinema', 'clinic', 'college', 'community_centre', 'courthouse', 'dentist', 'doctors', 'drinking_water', 'driving_school', 'fast_food', 'ferry_terminal', 'fire_station', 'food_court', 'fountain', 'fuel', 'grave_yard', 'hospital', 'hunting_stand', 'ice_cream', 'kindergarten', 'library', 'lounger', 'marketplace', 'motorcycle_parking', 'nightclub', 'parking', 'parking_entrance', 'pharmacy', 'phone', 'place_of_worship', 'police', 'post_box', 'post_office', 'prison', 'pub', 'public_bath', 'recycling', 'restaurant', 'school', 'shelter', 'shower', 'social_facility', 'taxi', 'theatre', 'toilets', 'townhall', 'university', 'veterinary', 'waste_basket', 'waste_disposal', 'water_point')) OR
                            ("natural" IN ('bare_rock', 'bay', 'beach', 'cave_entrance', 'geyser', 'glacier', 'grassland', 'heath', 'hot_spring', 'mud', 'peak', 'reef', 'saddle', 'sand', 'scree', 'scrub', 'shingle', 'shoal', 'spring', 'tree', 'volcano', 'water', 'wetland', 'wood')) OR
                            ("tourism" IN ('alpine_hut', 'apartment', 'artwork', 'camp_site', 'caravan_site', 'charlet', 'guest_house', 'hostel', 'hotel', 'information', 'motel', 'museum', 'picnic_site', 'theme_park', 'viewpoint', 'wilderness_hut', 'zoo')) OR
                            ("power" IN ('generator', 'plant', 'substation')) OR
                            ("railway" IN ('crossing', 'halt', 'level_crossing', 'station', 'subway_entrance', 'tram_stop')) OR
                            ("man_made" IN ('bridge', 'bunker_silo', 'communications_tower', 'crane', 'cross', 'gasometer', 'heap', 'lighthouse', 'mast', 'obelisk', 'petroleum_well', 'planter', 'reservoir_covered', 'silo', 'spoil_heap', 'storage_tank', 'telescope', 'tower', 'water_tap', 'water_tower', 'water_well', 'watermill', 'windmill', 'windpump', 'works')) OR
                            ("aerialway" IN ('station')) OR
                            ("highway" IN ('bus_stop', 'elevator', 'rest_area', 'services', 'traffic_signals')) OR
                            ("historic" IN ('archaeological_site', 'castle', 'city_gate', 'fort', 'manor', 'memorial', 'monument', 'wayside_cross', 'wayside_shrine')) OR
                            ("barrier" IN ('block', 'bollard', 'cattle_grid', 'chain', 'cycle_barrier', 'full-height_turnstile', 'gate', 'hampshire_gate', 'height_restrictor', 'kissing_gate', 'lift_gate', 'log', 'sliding_gate', 'stile', 'swing_gate', 'toll_booth', 'turnstile', 'wicket_gate')) OR
                            ((tags->'office') IS NOT NULL) OR
                            ((tags->'emergency') IN ('life_ring', 'phone')) OR
                            ((tags->'advertising') IN ('column'))
                        END
                    UNION ALL
                    SELECT
                        ST_PointOnSurface(way) AS way,
                        "access",
                        "aerialway",
                        "aeroway",
                        "amenity",
                        "barrier",
                        "building",
                        "highway",
                        "historic",
                        "landuse",
                        "leisure",
                        "man_made",
                        "military",
                        "name",
                        "natural",
                        "osm_id",
                        "place",
                        "power",
                        "railway",
                        "ref",
                        "religion",
                        "shop",
                        "tourism",
                        "waterway",
                        tags->'advertising' AS "advertising",
                        tags->'backrest' AS "backrest",
                        tags->'brand' AS "brand",
                        tags->'castle_type' AS "castle_type",
                        tags->'circumference' AS "circumference",
                        tags->'content' AS "content",
                        tags->'crane:type' AS "crane:type",
                        tags->'diameter' AS "diameter",
                        tags->'diameter_crown' AS "diameter_crown",
                        tags->'diplomatic' AS "diplomatic",
                        tags->'disused' AS "disused",
                        tags->'drinking_water' AS "drinking_water",
                        tags->'emergency' AS "emergency",
                        tags->'gate:type' AS "gate:type",
                        tags->'height' AS "height",
                        tags->'iata' AS "iata",
                        tags->'icao' AS "icao",
                        tags->'information' AS "information",
                        tags->'intermittent' AS "intermittent",
                        tags->'kissing_gate' AS "kissing_gate",
                        tags->'location' AS "location",
                        tags->'material' AS "material",
                        tags->'memorial' AS "memorial",
                        tags->'office' AS "office",
                        tags->'offshore' AS "offshore",
                        tags->'operator' AS "operator",
                        tags->'parking' AS "parking",
                        tags->'pump' AS "pump",
                        tags->'recycling_type' AS "recycling_type",
                        tags->'resource' AS "resource",
                        tags->'roof:shape' AS "roof:shape",
                        tags->'seamark:light:character' AS "seamark:light:character",
                        tags->'seamark:type' AS "seamark:type",
                        tags->'shelter_type' AS "shelter_type",
                        tags->'stile' AS "stile",
                        tags->'substance' AS "substance",
                        tags->'telescope:type' AS "telescope:type",
                        tags->'tower:construction' AS "tower:construction",
                        tags->'tower:type' AS "tower:type",
                        tags->'waste' AS "waste",
                        tags,
                        NULL AS way_length,
                        way_area
                      FROM planet_osm_polygon
                      WHERE way && !bbox!
                        AND way_area < 768000*POW(!scale_denominator!*0.001*0.28,2)
                        AND ("place" NOT IN ('archipelago') OR "place" IS NULL)
                        AND
                        CASE
                          WHEN z(!scale_denominator!) <= 9 THEN FALSE
                          WHEN z(!scale_denominator!) <= 10 THEN
                            ("aeroway" IN ('apron') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("aeroway" IN ('aerodrome')) OR
                            ("leisure" IN ('common', 'dog_park', 'fitness_centre', 'fitness_station', 'garden', 'park', 'sport_centre', 'stadium') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("shop" IN ('mall') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("place" IN ('island') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("landuse" IN ('allotments', 'basin', 'brownfield', 'cemetery', 'commercial', 'construction', 'farmland', 'farmyard', 'forest', 'grass', 'greenhouse_horticulture', 'landfill', 'meadow', 'military', 'quarry', 'recreation_ground', 'reservoir', 'village_green') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("military" IN ('danger_area') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("amenity" IN ('college', 'grave_yard', 'kindergarten', 'school', 'university') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("natural" IN ('bare_rock', 'beach', 'glacier', 'grassland', 'heath', 'mud', 'reef', 'sand', 'scree', 'scrub', 'shingle', 'shoal', 'water', 'wetland', 'wood') AND way_area >= 750*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("tourism" IN ('theme_park', 'zoo') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("power" IN ('generator', 'plant') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0))
                          WHEN z(!scale_denominator!) <= 11 THEN
                            ("aeroway" IN ('apron') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("aeroway" IN ('aerodrome')) OR
                            ("leisure" IN ('common', 'dog_park', 'fitness_centre', 'fitness_station', 'garden', 'park', 'sport_centre', 'stadium') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("shop" IN ('mall') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("place" IN ('island', 'islet') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("landuse" IN ('allotments', 'basin', 'brownfield', 'cemetery', 'commercial', 'construction', 'farmland', 'farmyard', 'forest', 'grass', 'greenhouse_horticulture', 'landfill', 'meadow', 'military', 'quarry', 'recreation_ground', 'reservoir', 'village_green') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("military" IN ('danger_area') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("amenity" IN ('college', 'grave_yard', 'kindergarten', 'school', 'university') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("natural" IN ('bare_rock', 'beach', 'glacier', 'grassland', 'heath', 'mud', 'reef', 'sand', 'scree', 'scrub', 'shingle', 'shoal', 'water', 'wetland', 'wood') AND way_area >= 750*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("tourism" IN ('theme_park', 'zoo') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("power" IN ('generator', 'plant') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0))
                          WHEN z(!scale_denominator!) <= 12 THEN
                            ("aeroway" IN ('apron') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("aeroway" IN ('aerodrome')) OR
                            ("leisure" IN ('common', 'dog_park', 'fitness_centre', 'fitness_station', 'garden', 'park', 'sport_centre', 'stadium') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("shop" IN ('mall') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("place" IN ('island', 'islet') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("landuse" IN ('allotments', 'basin', 'brownfield', 'cemetery', 'commercial', 'construction', 'farmland', 'farmyard', 'forest', 'grass', 'greenhouse_horticulture', 'landfill', 'meadow', 'military', 'quarry', 'recreation_ground', 'reservoir', 'village_green') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("military" IN ('danger_area') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("amenity" IN ('college', 'grave_yard', 'kindergarten', 'school', 'university') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("natural" IN ('bare_rock', 'beach', 'glacier', 'grassland', 'heath', 'mud', 'reef', 'sand', 'scree', 'scrub', 'shingle', 'shoal', 'water', 'wetland', 'wood') AND way_area >= 750*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("tourism" IN ('theme_park', 'zoo') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("power" IN ('generator', 'plant') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("railway" IN ('station')) OR
                            ("man_made" IN ('bridge') AND way_area >= 62*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0))
                          WHEN z(!scale_denominator!) <= 13 THEN
                            ("aeroway" IN ('apron') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("aeroway" IN ('aerodrome')) OR
                            ("leisure" IN ('common', 'dog_park', 'fitness_centre', 'fitness_station', 'garden', 'park', 'sport_centre', 'stadium') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("shop" IN ('mall') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("place" IN ('island', 'islet') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("landuse" IN ('allotments', 'basin', 'brownfield', 'cemetery', 'commercial', 'construction', 'farmland', 'farmyard', 'forest', 'garages', 'grass', 'greenhouse_horticulture', 'industrial', 'landfill', 'meadow', 'military', 'quarry', 'railway', 'recreation_ground', 'reservoir', 'residential', 'retail', 'village_green') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("military" IN ('danger_area') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("amenity" IN ('college', 'grave_yard', 'kindergarten', 'school', 'university') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("natural" IN ('bare_rock', 'beach', 'glacier', 'grassland', 'heath', 'mud', 'reef', 'sand', 'scree', 'scrub', 'shingle', 'shoal', 'water', 'wetland', 'wood') AND way_area >= 750*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("natural" IN ('volcano')) OR
                            ("tourism" IN ('theme_park', 'zoo') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("tourism" IN ('alpine_hut', 'wilderness_hut')) OR
                            ("power" IN ('generator', 'plant', 'substation') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("railway" IN ('station')) OR
                            ("man_made" IN ('bridge', 'works') AND way_area >= 62*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("aerialway" IN ('station')) OR
                            ("highway" IN ('rest_area', 'services') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0))
                          WHEN z(!scale_denominator!) <= 14 THEN
                            ("aeroway" IN ('apron') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("aeroway" IN ('aerodrome')) OR
                            ("leisure" IN ('common', 'dog_park', 'fitness_centre', 'fitness_station', 'garden', 'park', 'sport_centre', 'stadium', 'swimming_pool', 'water_park') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("shop" IN ('mall') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("place" IN ('island', 'islet') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("landuse" IN ('allotments', 'basin', 'brownfield', 'cemetery', 'commercial', 'construction', 'farmland', 'farmyard', 'forest', 'garages', 'grass', 'greenhouse_horticulture', 'industrial', 'landfill', 'meadow', 'military', 'quarry', 'railway', 'recreation_ground', 'reservoir', 'residential', 'retail', 'village_green') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("military" IN ('danger_area') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("amenity" IN ('bicycle_parking', 'college', 'grave_yard', 'kindergarten', 'motorcycle_parking', 'parking', 'school', 'university') AND way_area >= 900*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("natural" IN ('bare_rock', 'beach', 'glacier', 'grassland', 'heath', 'mud', 'reef', 'sand', 'scree', 'scrub', 'shingle', 'shoal', 'water', 'wetland', 'wood') AND way_area >= 750*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("natural" IN ('bay', 'geyser', 'hot_spring', 'spring', 'volcano')) OR
                            ("tourism" IN ('theme_park', 'zoo') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("tourism" IN ('alpine_hut', 'wilderness_hut')) OR
                            ("power" IN ('generator', 'plant', 'substation') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("railway" IN ('station')) OR
                            ("man_made" IN ('bridge', 'works') AND way_area >= 62*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("man_made" IN ('communications_tower', 'mast', 'tower')) OR
                            ("aerialway" IN ('station')) OR
                            ("highway" IN ('rest_area', 'services') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0))
                          WHEN z(!scale_denominator!) <= 15 THEN
                            ("aeroway" IN ('apron') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("aeroway" IN ('aerodrome')) OR
                            ("leisure" IN ('common', 'dog_park', 'fitness_centre', 'fitness_station', 'garden', 'marina', 'park', 'sport_centre', 'stadium', 'swimming_pool', 'water_park') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("leisure" IN ('golf_course')) OR
                            ("shop" IN ('mall') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("place" IN ('island', 'islet') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("landuse" IN ('allotments', 'basin', 'brownfield', 'cemetery', 'commercial', 'construction', 'farmland', 'farmyard', 'forest', 'garages', 'grass', 'greenhouse_horticulture', 'industrial', 'landfill', 'meadow', 'military', 'quarry', 'railway', 'recreation_ground', 'reservoir', 'residential', 'retail', 'village_green') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("military" IN ('danger_area') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("amenity" IN ('bicycle_parking', 'college', 'grave_yard', 'kindergarten', 'motorcycle_parking', 'parking', 'school', 'university') AND way_area >= 900*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("amenity" IN ('ferry_terminal', 'hospital')) OR
                            ("natural" IN ('bare_rock', 'beach', 'glacier', 'grassland', 'heath', 'mud', 'reef', 'sand', 'scree', 'scrub', 'shingle', 'shoal', 'water', 'wetland', 'wood') AND way_area >= 750*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("natural" IN ('bay', 'geyser', 'hot_spring', 'spring', 'volcano')) OR
                            ("tourism" IN ('theme_park', 'zoo') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("tourism" IN ('alpine_hut', 'wilderness_hut')) OR
                            ("power" IN ('generator', 'plant', 'substation') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("railway" IN ('station')) OR
                            ("man_made" IN ('bridge', 'gasometer', 'heap', 'spoil_heap', 'works') AND way_area >= 62*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("man_made" IN ('communications_tower', 'lighthouse', 'mast', 'tower', 'water_well')) OR
                            ("aerialway" IN ('station')) OR
                            ("highway" IN ('rest_area', 'services') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("historic" IN ('castle'))
                          WHEN z(!scale_denominator!) <= 16 THEN
                            ("aeroway" IN ('apron') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("aeroway" IN ('aerodrome', 'helipad')) OR
                            ("leisure" IN ('common', 'dog_park', 'fitness_centre', 'fitness_station', 'garden', 'marina', 'park', 'sport_centre', 'stadium', 'swimming_pool', 'water_park') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("leisure" IN ('beach_resort', 'golf_course')) OR
                            ("shop" IS NOT NULL) OR
                            ("place" IN ('islet') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("place" IN ('island')) OR
                            ("landuse" IN ('allotments', 'basin', 'brownfield', 'cemetery', 'commercial', 'construction', 'farmland', 'farmyard', 'forest', 'garages', 'grass', 'greenhouse_horticulture', 'industrial', 'landfill', 'meadow', 'military', 'quarry', 'railway', 'recreation_ground', 'reservoir', 'residential', 'retail', 'village_green') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("military" IN ('danger_area') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("amenity" IN ('college', 'grave_yard', 'kindergarten', 'marketplace', 'school', 'university') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("amenity" IN ('bicycle_parking', 'bus_station', 'cinema', 'clinic', 'courthouse', 'ferry_terminal', 'fire_station', 'hospital', 'hunting_stand', 'library', 'motorcycle_parking', 'parking', 'place_of_worship', 'police', 'shelter', 'theatre', 'townhall')) OR
                            ("natural" IN ('bare_rock', 'beach', 'glacier', 'grassland', 'heath', 'mud', 'reef', 'sand', 'scree', 'scrub', 'shingle', 'shoal', 'water', 'wetland', 'wood') AND way_area >= 750*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("natural" IN ('bay', 'geyser', 'hot_spring', 'spring', 'volcano')) OR
                            ("tourism" IN ('theme_park', 'zoo') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("tourism" IN ('alpine_hut', 'museum', 'picnic_site', 'wilderness_hut')) OR
                            ("power" IN ('generator', 'plant', 'substation') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("railway" IN ('station')) OR
                            ("man_made" IN ('bridge', 'bunker_silo', 'gasometer', 'heap', 'silo', 'spoil_heap', 'storage_tank', 'works') AND way_area >= 62*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("man_made" IN ('communications_tower', 'lighthouse', 'mast', 'tower', 'water_well', 'windmill')) OR
                            ("aerialway" IN ('station')) OR
                            ("highway" IN ('rest_area', 'services') AND way_area >= 3000*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("historic" IN ('archaeological_site', 'castle', 'fort', 'manor', 'monument')) OR
                            ("barrier" IN ('toll_booth'))
                          WHEN z(!scale_denominator!) <= 17 THEN
                            ("aeroway" IN ('aerodrome', 'apron', 'helipad')) OR
                            ("leisure" IN ('beach_resort', 'common', 'dog_park', 'firepit', 'fitness_centre', 'fitness_station', 'garden', 'golf_course', 'marina', 'miniature_golf', 'park', 'picnic_table', 'playground', 'sauna', 'slipway', 'sport_centre', 'stadium', 'swimming_pool', 'water_park')) OR
                            ("shop" IS NOT NULL) OR
                            ("place" IN ('island', 'islet')) OR
                            ("landuse" IN ('allotments', 'basin', 'brownfield', 'cemetery', 'commercial', 'construction', 'farmland', 'farmyard', 'forest', 'garages', 'grass', 'greenhouse_horticulture', 'industrial', 'landfill', 'meadow', 'military', 'quarry', 'railway', 'recreation_ground', 'reservoir', 'residential', 'retail', 'village_green')) OR
                            ("military" IN ('bunker', 'danger_area')) OR
                            ("amenity" IN ('arts_centre', 'atm', 'bank', 'bar', 'bbq', 'bicycle_parking', 'bicycle_rental', 'biergarten', 'bus_station', 'cafe', 'car_rental', 'car_wash', 'charging_station', 'cinema', 'clinic', 'college', 'community_centre', 'courthouse', 'dentist', 'doctors', 'driving_school', 'fast_food', 'ferry_terminal', 'fire_station', 'food_court', 'fountain', 'fuel', 'grave_yard', 'hospital', 'hunting_stand', 'ice_cream', 'kindergarten', 'library', 'marketplace', 'motorcycle_parking', 'nightclub', 'parking', 'pharmacy', 'phone', 'place_of_worship', 'police', 'post_office', 'prison', 'pub', 'public_bath', 'recycling', 'restaurant', 'school', 'shelter', 'social_facility', 'taxi', 'theatre', 'toilets', 'townhall', 'university', 'veterinary')) OR
                            ("natural" IN ('bare_rock', 'bay', 'beach', 'geyser', 'glacier', 'grassland', 'heath', 'hot_spring', 'mud', 'reef', 'sand', 'scree', 'scrub', 'shingle', 'shoal', 'spring', 'volcano', 'water', 'wetland', 'wood')) OR
                            ("tourism" IN ('alpine_hut', 'artwork', 'camp_site', 'caravan_site', 'charlet', 'guest_house', 'hostel', 'hotel', 'information', 'motel', 'museum', 'picnic_site', 'theme_park', 'wilderness_hut', 'zoo')) OR
                            ("power" IN ('generator', 'plant', 'substation')) OR
                            ("railway" IN ('station')) OR
                            ("man_made" IN ('bridge', 'bunker_silo', 'silo', 'storage_tank') AND way_area >= 62*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("man_made" IN ('communications_tower', 'crane', 'gasometer', 'heap', 'lighthouse', 'mast', 'obelisk', 'petroleum_well', 'reservoir_covered', 'spoil_heap', 'telescope', 'tower', 'water_tower', 'water_well', 'watermill', 'windmill', 'works')) OR
                            ("aerialway" IN ('station')) OR
                            ("highway" IN ('rest_area', 'services')) OR
                            ("historic" IN ('archaeological_site', 'castle', 'city_gate', 'fort', 'manor', 'memorial', 'monument')) OR
                            ("barrier" IN ('block', 'gate', 'toll_booth')) OR
                            ((tags->'office') IS NOT NULL)
                          WHEN z(!scale_denominator!) <= 18 THEN
                            ("aeroway" IN ('aerodrome', 'apron', 'helipad')) OR
                            ("leisure" IN ('beach_resort', 'common', 'dog_park', 'firepit', 'fitness_centre', 'fitness_station', 'garden', 'golf_course', 'marina', 'miniature_golf', 'park', 'picnic_table', 'playground', 'sauna', 'slipway', 'sport_centre', 'stadium', 'swimming_pool', 'water_park')) OR
                            ("shop" IS NOT NULL) OR
                            ("place" IN ('island', 'islet')) OR
                            ("landuse" IN ('allotments', 'basin', 'brownfield', 'cemetery', 'commercial', 'construction', 'farmland', 'farmyard', 'forest', 'garages', 'grass', 'greenhouse_horticulture', 'industrial', 'landfill', 'meadow', 'military', 'quarry', 'railway', 'recreation_ground', 'reservoir', 'residential', 'retail', 'village_green')) OR
                            ("military" IN ('bunker', 'danger_area')) OR
                            ("amenity" IN ('arts_centre', 'atm', 'bank', 'bar', 'bbq', 'bench', 'bicycle_parking', 'bicycle_rental', 'biergarten', 'bus_station', 'cafe', 'car_rental', 'car_wash', 'charging_station', 'cinema', 'clinic', 'college', 'community_centre', 'courthouse', 'dentist', 'doctors', 'driving_school', 'fast_food', 'ferry_terminal', 'fire_station', 'food_court', 'fountain', 'fuel', 'grave_yard', 'hospital', 'hunting_stand', 'ice_cream', 'kindergarten', 'library', 'lounger', 'marketplace', 'motorcycle_parking', 'nightclub', 'parking', 'pharmacy', 'phone', 'place_of_worship', 'police', 'post_office', 'prison', 'pub', 'public_bath', 'recycling', 'restaurant', 'school', 'shelter', 'shower', 'social_facility', 'taxi', 'theatre', 'toilets', 'townhall', 'university', 'veterinary', 'waste_disposal')) OR
                            ("natural" IN ('bare_rock', 'bay', 'beach', 'geyser', 'glacier', 'grassland', 'heath', 'hot_spring', 'mud', 'reef', 'sand', 'scree', 'scrub', 'shingle', 'shoal', 'spring', 'volcano', 'water', 'wetland', 'wood')) OR
                            ("tourism" IN ('alpine_hut', 'apartment', 'artwork', 'camp_site', 'caravan_site', 'charlet', 'guest_house', 'hostel', 'hotel', 'information', 'motel', 'museum', 'picnic_site', 'theme_park', 'wilderness_hut', 'zoo')) OR
                            ("power" IN ('generator', 'plant', 'substation')) OR
                            ("railway" IN ('station', 'subway_entrance')) OR
                            ("man_made" IN ('bridge') AND way_area >= 62*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("man_made" IN ('bunker_silo', 'communications_tower', 'crane', 'gasometer', 'heap', 'lighthouse', 'mast', 'obelisk', 'petroleum_well', 'reservoir_covered', 'silo', 'spoil_heap', 'storage_tank', 'telescope', 'tower', 'water_tower', 'water_well', 'watermill', 'windmill', 'works')) OR
                            ("aerialway" IN ('station')) OR
                            ("highway" IN ('elevator', 'rest_area', 'services')) OR
                            ("historic" IN ('archaeological_site', 'castle', 'city_gate', 'fort', 'manor', 'memorial', 'monument')) OR
                            ("barrier" IN ('block', 'chain', 'gate', 'toll_booth')) OR
                            ((tags->'office') IS NOT NULL)
                          ELSE
                            ("aeroway" IN ('aerodrome', 'apron', 'helipad')) OR
                            ("leisure" IN ('beach_resort', 'common', 'dog_park', 'firepit', 'fitness_centre', 'fitness_station', 'garden', 'golf_course', 'marina', 'miniature_golf', 'park', 'picnic_table', 'playground', 'sauna', 'slipway', 'sport_centre', 'stadium', 'swimming_pool', 'water_park')) OR
                            ("shop" IS NOT NULL) OR
                            ("place" IN ('island', 'islet')) OR
                            ("landuse" IN ('allotments', 'basin', 'brownfield', 'cemetery', 'commercial', 'construction', 'farmland', 'farmyard', 'forest', 'garages', 'grass', 'greenhouse_horticulture', 'industrial', 'landfill', 'meadow', 'military', 'quarry', 'railway', 'recreation_ground', 'reservoir', 'residential', 'retail', 'village_green')) OR
                            ("military" IN ('bunker', 'danger_area')) OR
                            ("amenity" IN ('arts_centre', 'atm', 'bank', 'bar', 'bbq', 'bench', 'bicycle_parking', 'bicycle_rental', 'biergarten', 'bus_station', 'cafe', 'car_rental', 'car_wash', 'charging_station', 'cinema', 'clinic', 'college', 'community_centre', 'courthouse', 'dentist', 'doctors', 'driving_school', 'fast_food', 'ferry_terminal', 'fire_station', 'food_court', 'fountain', 'fuel', 'grave_yard', 'hospital', 'hunting_stand', 'ice_cream', 'kindergarten', 'library', 'lounger', 'marketplace', 'motorcycle_parking', 'nightclub', 'parking', 'pharmacy', 'phone', 'place_of_worship', 'police', 'post_office', 'prison', 'pub', 'public_bath', 'recycling', 'restaurant', 'school', 'shelter', 'shower', 'social_facility', 'taxi', 'theatre', 'toilets', 'townhall', 'university', 'veterinary', 'waste_disposal')) OR
                            ("natural" IN ('bare_rock', 'bay', 'beach', 'geyser', 'glacier', 'grassland', 'heath', 'hot_spring', 'mud', 'reef', 'sand', 'scree', 'scrub', 'shingle', 'shoal', 'spring', 'volcano', 'water', 'wetland', 'wood')) OR
                            ("tourism" IN ('alpine_hut', 'apartment', 'artwork', 'camp_site', 'caravan_site', 'charlet', 'guest_house', 'hostel', 'hotel', 'information', 'motel', 'museum', 'picnic_site', 'theme_park', 'wilderness_hut', 'zoo')) OR
                            ("power" IN ('generator', 'plant', 'substation')) OR
                            ("railway" IN ('station', 'subway_entrance')) OR
                            ("man_made" IN ('bridge') AND way_area >= 62*NULLIF(POW(!scale_denominator!*0.001*0.28,2),0)) OR
                            ("man_made" IN ('bunker_silo', 'communications_tower', 'crane', 'gasometer', 'heap', 'lighthouse', 'mast', 'obelisk', 'petroleum_well', 'reservoir_covered', 'silo', 'spoil_heap', 'storage_tank', 'telescope', 'tower', 'water_tower', 'water_well', 'watermill', 'windmill', 'works')) OR
                            ("aerialway" IN ('station')) OR
                            ("highway" IN ('elevator', 'rest_area', 'services')) OR
                            ("historic" IN ('archaeological_site', 'castle', 'city_gate', 'fort', 'manor', 'memorial', 'monument')) OR
                            ("barrier" IN ('block', 'chain', 'gate', 'toll_booth')) OR
                            ((tags->'office') IS NOT NULL) OR
                            ((tags->'advertising') IN ('column'))
                        END
                    UNION ALL
                    SELECT -- This is separately the archipelagos with the convex hull geometry processing
                        ST_ClosestPoint(oway,ST_PointOnSurface(way)) AS way,
                        "access",
                        "aerialway",
                        "aeroway",
                        "amenity",
                        "barrier",
                        "building",
                        "highway",
                        "historic",
                        "landuse",
                        "leisure",
                        "man_made",
                        "military",
                        "name",
                        "natural",
                        "osm_id",
                        "place",
                        "power",
                        "railway",
                        "ref",
                        "religion",
                        "shop",
                        "tourism",
                        "waterway",
                        tags->'advertising' AS "advertising",
                        tags->'backrest' AS "backrest",
                        tags->'brand' AS "brand",
                        tags->'castle_type' AS "castle_type",
                        tags->'circumference' AS "circumference",
                        tags->'content' AS "content",
                        tags->'crane:type' AS "crane:type",
                        tags->'diameter' AS "diameter",
                        tags->'diameter_crown' AS "diameter_crown",
                        tags->'diplomatic' AS "diplomatic",
                        tags->'disused' AS "disused",
                        tags->'drinking_water' AS "drinking_water",
                        tags->'emergency' AS "emergency",
                        tags->'gate:type' AS "gate:type",
                        tags->'height' AS "height",
                        tags->'iata' AS "iata",
                        tags->'icao' AS "icao",
                        tags->'information' AS "information",
                        tags->'intermittent' AS "intermittent",
                        tags->'kissing_gate' AS "kissing_gate",
                        tags->'location' AS "location",
                        tags->'material' AS "material",
                        tags->'memorial' AS "memorial",
                        tags->'office' AS "office",
                        tags->'offshore' AS "offshore",
                        tags->'operator' AS "operator",
                        tags->'parking' AS "parking",
                        tags->'pump' AS "pump",
                        tags->'recycling_type' AS "recycling_type",
                        tags->'resource' AS "resource",
                        tags->'roof:shape' AS "roof:shape",
                        tags->'seamark:light:character' AS "seamark:light:character",
                        tags->'seamark:type' AS "seamark:type",
                        tags->'shelter_type' AS "shelter_type",
                        tags->'stile' AS "stile",
                        tags->'substance' AS "substance",
                        tags->'telescope:type' AS "telescope:type",
                        tags->'tower:construction' AS "tower:construction",
                        tags->'tower:type' AS "tower:type",
                        tags->'waste' AS "waste",
                        tags,
                        NULL AS way_length,
                        ST_Area(ST_Envelope(oway)) AS way_area
                      FROM
                        (SELECT
                            (ST_Dump(
                              -- this detects multipolygons extending over the 180 degree meridian to split them
                              CASE WHEN (ST_XMax(way)-ST_XMin(way)) < 20037508 THEN
                                ST_ConvexHull(way)
                              ELSE
                                -- splits the polygon into the two hemisphere parts
                                ST_Collect(
                                  ST_ConvexHull(ST_Intersection(way, ST_SetSRID(ST_GeomFromText('POLYGON((-20037508 -20037508, -20037508 20037508, 0  20037508, 0 -20037508, -20037508 -20037508))'), 3857))),
                                  ST_ConvexHull(ST_Intersection(way, ST_SetSRID(ST_GeomFromText('POLYGON((0 -20037508, 0 20037508, 20037508 20037508, 20037508 -20037508, 0 -20037508))'), 3857)))
                                )
                              END
                            )).geom AS way,
                            way AS oway,
                            "access",
                            "aerialway",
                            "aeroway",
                            "amenity",
                            "barrier",
                            "building",
                            "highway",
                            "historic",
                            "landuse",
                            "leisure",
                            "man_made",
                            "military",
                            "name",
                            "natural",
                            "osm_id",
                            "place",
                            "power",
                            "railway",
                            "ref",
                            "religion",
                            "shop",
                            "tourism",
                            "waterway",
                            tags
                          FROM planet_osm_polygon
                          WHERE way && !bbox!
                            AND building IS NULL
                            AND "place" IN ('archipelago')
                        ) AS archipelagos
                  ) AS points_all
                ) AS features
                WHERE feature IS NOT NULL
              ) AS combined
              JOIN (VALUES
                  ('aeroway_helipad', 1),
                  ('aeroway_aerodrome+public', 2),
                  ('aeroway_aerodrome', 3),
                  ('aeroway_gate', 4),
                  ('aeroway_apron', 5),
                  ('railway_crossing', 6),
                  ('railway_level_crossing', 7),
                  ('railway_halt', 8),
                  ('railway_tram_stop', 9),
                  ('railway_subway_entrance', 10),
                  ('railway_station', 11),
                  ('highway_bus_stop', 12),
                  ('highway_traffic_signals', 13),
                  ('highway_elevator', 14),
                  ('highway_services', 15),
                  ('highway_rest_area', 16),
                  ('natural_spring+connected', 17),
                  ('natural_spring', 18),
                  ('natural_hot_spring+connected', 19),
                  ('natural_hot_spring', 20),
                  ('natural_geyser', 21),
                  ('natural_bay', 22),
                  ('natural_volcano', 23),
                  ('natural_tree', 24),
                  ('natural_saddle', 25),
                  ('natural_cave_entrance', 26),
                  ('natural_peak/viewpoint', 27),
                  ('natural_peak', 28),
                  ('natural_grassland', 29),
                  ('natural_wood', 30),
                  ('natural_wetland', 31),
                  ('natural_reef', 32),
                  ('natural_mud', 33),
                  ('natural_heath', 34),
                  ('natural_scrub', 35),
                  ('natural_beach', 36),
                  ('natural_shoal', 37),
                  ('natural_sand', 38),
                  ('natural_scree', 39),
                  ('natural_shingle', 40),
                  ('natural_bare_rock', 41),
                  ('natural_glacier', 42),
                  ('natural_water', 43),
                  ('aerialway_station', 44),
                  ('tourism_alpine_hut', 45),
                  ('tourism_wilderness_hut', 46),
                  ('tourism_charlet', 47),
                  ('tourism_hostel', 48),
                  ('tourism_hotel', 49),
                  ('tourism_motel', 50),
                  ('tourism_guest_house', 51),
                  ('tourism_apartment', 52),
                  ('tourism_museum', 53),
                  ('tourism_artwork', 54),
                  ('tourism_camp_site', 55),
                  ('tourism_caravan_site', 56),
                  ('tourism_picnic_site', 57),
                  ('tourism_information+information_audioguide', 58),
                  ('tourism_information+information_board', 59),
                  ('tourism_information+information_sign', 60),
                  ('tourism_information+information_guidepost', 61),
                  ('tourism_information+information_map', 62),
                  ('tourism_information+information_terminal', 63),
                  ('tourism_information+information_visitor_centre', 64),
                  ('tourism_information', 65),
                  ('tourism_viewpoint', 66),
                  ('tourism_theme_park', 67),
                  ('tourism_zoo', 68),
                  ('amenity_shelter', 69),
                  ('amenity_atm', 70),
                  ('amenity_bank', 71),
                  ('amenity_bar', 72),
                  ('amenity_bbq', 73),
                  ('amenity_cafe', 74),
                  ('amenity_ice_cream', 75),
                  ('amenity_nightclub', 76),
                  ('amenity_pub', 77),
                  ('amenity_biergarten', 78),
                  ('amenity_restaurant', 79),
                  ('amenity_food_court', 80),
                  ('amenity_fast_food', 81),
                  ('amenity_fire_station', 82),
                  ('amenity_cinema', 83),
                  ('amenity_library', 84),
                  ('amenity_courthouse', 85),
                  ('amenity_townhall', 86),
                  ('amenity_police', 87),
                  ('amenity_prison', 88),
                  ('amenity_post_office', 89),
                  ('amenity_theatre', 90),
                  ('amenity_arts_centre', 91),
                  ('amenity_community_centre', 92),
                  ('amenity_social_facility', 93),
                  ('amenity_shower', 94),
                  ('amenity_public_bath', 95),
                  ('amenity_toilets+access_yes', 96),
                  ('amenity_toilets', 97),
                  ('amenity_motorcycle_parking', 98),
                  ('amenity_bicycle_parking', 99),
                  ('amenity_bicycle_rental', 100),
                  ('amenity_bus_station', 101),
                  ('amenity_ferry_terminal', 102),
                  ('amenity_car_rental', 103),
                  ('amenity_car_wash', 104),
                  ('amenity_charging_station', 105),
                  ('amenity_fuel', 106),
                  ('amenity_taxi', 107),
                  ('amenity_phone', 108),
                  ('amenity_bench', 109),
                  ('amenity_lounger', 110),
                  ('amenity_waste_disposal', 111),
                  ('amenity_recycling+centre', 112),
                  ('amenity_recycling+container', 113),
                  ('amenity_recycling', 114),
                  ('amenity_fountain', 115),
                  ('amenity_hunting_stand', 116),
                  ('amenity_place_of_worship', 117),
                  ('amenity_hospital', 118),
                  ('amenity_pharmacy', 119),
                  ('amenity_dentist', 120),
                  ('amenity_doctors', 121),
                  ('amenity_clinic', 122),
                  ('amenity_veterinary', 123),
                  ('amenity_driving_school', 124),
                  ('amenity_marketplace', 125),
                  ('amenity_post_box', 126),
                  ('amenity_waste_basket+recycling', 127),
                  ('amenity_waste_basket', 128),
                  ('amenity_water_point+drinking_water', 129),
                  ('amenity_water_point', 130),
                  ('amenity_parking+street_side', 131),
                  ('amenity_parking', 132),
                  ('amenity_parking_entrance/multi-storey', 133),
                  ('amenity_parking_entrance/underground', 134),
                  ('amenity_drinking_water', 135),
                  ('amenity_grave_yard', 136),
                  ('amenity_kindergarten', 137),
                  ('amenity_school', 138),
                  ('amenity_college', 139),
                  ('amenity_university', 140),
                  ('office+diplomatic', 141),
                  ('office+large', 142),
                  ('office', 143),
                  ('advertising_column', 144),
                  ('emergency_life_ring', 145),
                  ('emergency_phone', 146),
                  ('shop_massage', 147),
                  ('shop_mall', 148),
                  ('shop+early', 149),
                  ('shop', 150),
                  ('leisure_water_park', 151),
                  ('leisure_playground', 152),
                  ('leisure_miniature_golf', 153),
                  ('leisure_golf_course', 154),
                  ('leisure_picnic_table', 155),
                  ('leisure_firepit', 156),
                  ('leisure_sauna', 157),
                  ('leisure_beach_resort', 158),
                  ('leisure_slipway', 159),
                  ('leisure_fitness_centre', 160),
                  ('leisure_fitness_station', 161),
                  ('leisure_dog_park', 162),
                  ('leisure_swimming_pool', 163),
                  ('leisure_common', 164),
                  ('leisure_garden', 165),
                  ('leisure_sport_centre', 166),
                  ('leisure_stadium', 167),
                  ('leisure_park', 168),
                  ('leisure_marina', 169),
                  ('power_generator/wind+offshore', 170),
                  ('power_generator/wind', 171),
                  ('power_plant', 172),
                  ('power_substation', 173),
                  ('power_generator', 174),
                  ('man_made_planter', 175),
                  ('man_made_water_tap', 176),
                  ('man_made_windpump', 177),
                  ('man_made_cross', 178),
                  ('man_made_water_well', 179),
                  ('man_made_windmill', 180),
                  ('man_made_watermill', 181),
                  ('man_made_water_tower', 182),
                  ('man_made_silo', 183),
                  ('man_made_bunker_silo', 184),
                  ('man_made_reservoir_covered', 185),
                  ('man_made_heap', 186),
                  ('man_made_spoil_heap', 187),
                  ('man_made_gasometer', 188),
                  ('man_made_storage_tank', 189),
                  ('man_made_lighthouse', 190),
                  ('man_made_telescope', 191),
                  ('man_made_crane', 192),
                  ('man_made_mast+height_160', 193),
                  ('man_made_mast+height_80', 194),
                  ('man_made_mast+height_40', 195),
                  ('man_made_mast+height_20', 196),
                  ('man_made_mast', 197),
                  ('man_made_tower+height_160', 198),
                  ('man_made_tower+height_80', 199),
                  ('man_made_tower+height_40', 200),
                  ('man_made_tower+minor_types', 201),
                  ('man_made_tower', 202),
                  ('man_made_communications_tower', 203),
                  ('man_made_petroleum_well', 204),
                  ('man_made_obelisk', 205),
                  ('man_made_bridge', 206),
                  ('man_made_works', 207),
                  ('landuse_military', 208),
                  ('landuse_garages', 209),
                  ('landuse_retail', 210),
                  ('landuse_residential', 211),
                  ('landuse_industrial', 212),
                  ('landuse_railway', 213),
                  ('landuse_cemetery', 214),
                  ('landuse_commercial', 215),
                  ('landuse_quarry', 216),
                  ('landuse_brownfield', 217),
                  ('landuse_landfill', 218),
                  ('landuse_construction', 219),
                  ('landuse_village_green', 220),
                  ('landuse_meadow', 221),
                  ('landuse_grass', 222),
                  ('landuse_allotments', 223),
                  ('landuse_farmyard', 224),
                  ('landuse_farmland', 225),
                  ('landuse_greenhouse_horticulture', 226),
                  ('landuse_forest', 227),
                  ('landuse_reservoir', 228),
                  ('landuse_basin', 229),
                  ('landuse_recreation_ground', 230),
                  ('waterway_waterfall', 231),
                  ('place_archipelago', 232),
                  ('place_island', 233),
                  ('place_islet', 234),
                  ('historic_city_gate', 235),
                  ('historic_memorial+medium', 236),
                  ('historic_memorial+small', 237),
                  ('historic_memorial', 238),
                  ('historic_monument', 239),
                  ('historic_fort', 240),
                  ('historic_castle+minor_types', 241),
                  ('historic_castle', 242),
                  ('historic_manor', 243),
                  ('historic_archaeological_site', 244),
                  ('historic_wayside_cross', 245),
                  ('historic_wayside_shrine', 246),
                  ('military_bunker', 247),
                  ('military_danger_area', 248),
                  ('barrier_gate', 249),
                  ('barrier_chain', 250),
                  ('barrier_block', 251),
                  ('barrier_toll_booth', 252),
                  ('barrier_lift_gate', 253),
                  ('barrier_swing_gate', 254),
                  ('barrier_cycle_barrier', 255),
                  ('barrier_stile', 256),
                  ('barrier_cattle_grid', 257),
                  ('barrier_kissing_gate', 258),
                  ('barrier_height_restrictor', 259),
                  ('barrier_sliding_gate', 260),
                  ('barrier_turnstile', 261),
                  ('barrier_full-height_turnstile', 262),
                  ('barrier_wicket_gate', 263),
                  ('barrier_hampshire_gate', 264),
                  ('barrier_log', 265),
                  ('barrier_bollard', 266)
                ) AS f (feature, prio)
                ON f.feature = CONCAT(combined.feature, '+'||combined.variant)
            ) -- end of zoom_thresholds CTE
            SELECT -- this is the symbols features only
                way,
                "name",
                "lang",
                "font",
                "ref",
                "operator",
                "brand",
                "osm_id",
                feature,
                variant,
                start_symbol,
                start_label,
                prio,
                CASE
                  WHEN z(!scale_denominator!) >= start_label THEN
                    'symbol-for-label'
                  ELSE
                    'symbol-only'
                END AS vis_type,
                "int_elevation",
                "shelter_type",
                "information",
                "int_access",
                "parking",
                "int_bench_type",
                "backrest",
                "waste",
                "recycling_type",
                "int_gate_type",
                "int_barrier_orientation",
                "stile",
                "kissing_gate",
                "int_maxheight",
                "int_text_dy_viewpoint",
                "int_offset_x_viewpoint",
                "int_offset_y_viewpoint",
                "int_width_viewpoint",
                "int_height_viewpoint",
                "icao",
                "iata",
                "drinking_water",
                "intermittent",
                "int_text_offset_tree",
                "location",
                "offshore",
                "content",
                "resource",
                "int_lighthouse_type",
                "telescope:type",
                "crane:type",
                "height",
                "tower:type",
                "int_tower_type",
                "int_petroleum_well_type",
                "memorial",
                "castle_type",
                "religion",
                "shop",
                "office",
                "diplomatic",
                "building",
                way_area,
                way_length,
                way_pixels
              FROM zoom_thresholds
              WHERE z(!scale_denominator!) >= start_symbol
            UNION ALL
            SELECT -- this is the labels features only
                way,
                "name",
                "lang",
                "font",
                "ref",
                "operator",
                "brand",
                "osm_id",
                feature,
                variant,
                start_symbol,
                start_label,
                prio,
                CASE
                  WHEN z(!scale_denominator!) >= start_symbol THEN
                    'label-for-symbol'
                  ELSE
                    'label-only'
                END AS vis_type,
                "int_elevation",
                "shelter_type",
                "information",
                "int_access",
                "parking",
                "int_bench_type",
                "backrest",
                "waste",
                "recycling_type",
                "int_gate_type",
                "int_barrier_orientation",
                "stile",
                "kissing_gate",
                "int_maxheight",
                "int_text_dy_viewpoint",
                "int_offset_x_viewpoint",
                "int_offset_y_viewpoint",
                "int_width_viewpoint",
                "int_height_viewpoint",
                "icao",
                "iata",
                "drinking_water",
                "intermittent",
                "int_text_offset_tree",
                "location",
                "offshore",
                "content",
                "resource",
                "int_lighthouse_type",
                "telescope:type",
                "crane:type",
                "height",
                "tower:type",
                "int_tower_type",
                "int_petroleum_well_type",
                "memorial",
                "castle_type",
                "religion",
                "shop",
                "office",
                "diplomatic",
                "building",
                way_area,
                way_length,
                way_pixels
              FROM zoom_thresholds
              WHERE z(!scale_denominator!) >= start_label
          ) AS final
          ORDER BY
            (CASE WHEN vis_type IN ('label-for-symbol') THEN 2 ELSE 1 END) ASC, -- put the addon labels for symbols last
            (CASE
              WHEN start_symbol IS NULL THEN start_label
              WHEN start_label IS NULL THEN start_symbol
              ELSE 0.5*(start_symbol+start_label)
            END) ASC NULLS LAST,
            prio ASC NULLS LAST,
            way_pixels DESC NULLS LAST,
            way_length DESC NULLS LAST,
            char_length(name) DESC NULLS LAST,
            name DESC NULLS LAST
        ) AS amenity_points
    properties:
      minzoom: 10
